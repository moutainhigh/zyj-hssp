<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.hand.hec.expm.mapper.ExpReportDistMapper">
    <resultMap id="BaseResultMap" type="com.hand.hec.expm.dto.ExpReportDist">
        <result column="POSITION_ID" property="positionId" jdbcType="DECIMAL"/>
        <result column="EMPLOYEE_ID" property="employeeId" jdbcType="DECIMAL"/>
        <result column="ACC_ENTITY_ID" property="accEntityId" jdbcType="DECIMAL"/>
        <result column="RESP_CENTER_ID" property="respCenterId" jdbcType="DECIMAL"/>
        <result column="BGT_ENTITY_ID" property="bgtEntityId" jdbcType="DECIMAL"/>
        <result column="BGT_CENTER_ID" property="bgtCenterId" jdbcType="DECIMAL"/>
        <result column="PAYEE_CATEGORY" property="payeeCategory" jdbcType="VARCHAR"/>
        <result column="PAYEE_ID" property="payeeId" jdbcType="DECIMAL"/>
        <result column="PAYMENT_FLAG" property="paymentFlag" jdbcType="VARCHAR"/>
        <result column="REPORT_STATUS" property="reportStatus" jdbcType="VARCHAR"/>
        <result column="CLOSE_FLAG" property="closeFlag" jdbcType="VARCHAR"/>
        <result column="CLOSE_DATE" property="closeDate" jdbcType="DATE"/>
        <result column="CLOSE_DATE_TZ" property="closeDateTz" jdbcType="DATE"/>
        <result column="CLOSE_DATE_LTZ" property="closeDateLtz" jdbcType="DATE"/>
        <result column="AUDIT_FLAG" property="auditFlag" jdbcType="VARCHAR"/>
        <result column="AUDIT_DATE" property="auditDate" jdbcType="DATE"/>
        <result column="AUDIT_DATE_TZ" property="auditDateTz" jdbcType="DATE"/>
        <result column="AUDIT_DATE_LTZ" property="auditDateLtz" jdbcType="DATE"/>
        <result column="WRITE_OFF_STATUS" property="writeOffStatus" jdbcType="VARCHAR"/>
        <result column="WRITE_OFF_COMLETED_DATE" property="writeOffComletedDate" jdbcType="DATE"/>
        <result column="WRITE_OFF_COMLETED_DATE_TZ" property="writeOffComletedDateTz" jdbcType="DATE"/>
        <result column="WRITE_OFF_COMLETED_DATE_LTZ" property="writeOffComletedDateLtz" jdbcType="DATE"/>
        <result column="ATTACHMENT_NUM" property="attachmentNum" jdbcType="DECIMAL"/>
        <result column="DIMENSION1_ID" property="dimension1Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION2_ID" property="dimension2Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION3_ID" property="dimension3Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION4_ID" property="dimension4Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION5_ID" property="dimension5Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION6_ID" property="dimension6Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION7_ID" property="dimension7Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION8_ID" property="dimension8Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION9_ID" property="dimension9Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION10_ID" property="dimension10Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION11_ID" property="dimension11Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION12_ID" property="dimension12Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION13_ID" property="dimension13Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION14_ID" property="dimension14Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION15_ID" property="dimension15Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION16_ID" property="dimension16Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION17_ID" property="dimension17Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION18_ID" property="dimension18Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION19_ID" property="dimension19Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION20_ID" property="dimension20Id" jdbcType="DECIMAL"/>
        <result column="EXP_REPORT_DIST_ID" property="expReportDistId" jdbcType="DECIMAL"/>
        <result column="EXP_REPORT_LINE_ID" property="expReportLineId" jdbcType="DECIMAL"/>
        <result column="DESCRIPTION" property="description" jdbcType="VARCHAR"/>
        <result column="DATE_FROM" property="dateFrom" jdbcType="DATE"/>
        <result column="DATE_TO" property="dateTo" jdbcType="DATE"/>
        <result column="PERIOD_NAME" property="periodName" jdbcType="VARCHAR"/>
        <result column="BUSINESS_CURRENCY_CODE" property="businessCurrencyCode" jdbcType="VARCHAR"/>
        <result column="BIZ2PAY_EXCHANGE_TYPE" property="biz2payExchangeType" jdbcType="VARCHAR"/>
        <result column="BIZ2PAY_EXCHANGE_RATE" property="biz2payExchangeRate" jdbcType="DECIMAL"/>
        <result column="PAYMENT_CURRENCY_CODE" property="paymentCurrencyCode" jdbcType="VARCHAR"/>
        <result column="PAY2FUN_EXCHANGE_TYPE" property="pay2funExchangeType" jdbcType="VARCHAR"/>
        <result column="PAY2FUN_EXCHANGE_RATE" property="pay2funExchangeRate" jdbcType="DECIMAL"/>
        <result column="MANAGEMENT_CURRENCY_CODE" property="managementCurrencyCode" jdbcType="VARCHAR"/>
        <result column="PAY2MAG_EXCHANGE_TYPE" property="pay2magExchangeType" jdbcType="VARCHAR"/>
        <result column="PAY2MAG_EXCHANGE_RATE" property="pay2magExchangeRate" jdbcType="DECIMAL"/>
        <result column="MO_EXPENSE_TYPE_ID" property="moExpenseTypeId" jdbcType="DECIMAL"/>
        <result column="MO_EXPENSE_ITEM_ID" property="moExpenseItemId" jdbcType="DECIMAL"/>
        <result column="BUDGET_ITEM_ID" property="budgetItemId" jdbcType="DECIMAL"/>
        <result column="BUSINESS_PRICE" property="businessPrice" jdbcType="DECIMAL"/>
        <result column="PAYMENT_PRICE" property="paymentPrice" jdbcType="DECIMAL"/>
        <result column="MANAGEMENT_PRICE" property="managementPrice" jdbcType="DECIMAL"/>
        <result column="PRIMARY_QUANTITY" property="primaryQuantity" jdbcType="DECIMAL"/>
        <result column="PRIMARY_UOM" property="primaryUom" jdbcType="VARCHAR"/>
        <result column="SECONDARY_QUANTITY" property="secondaryQuantity" jdbcType="DECIMAL"/>
        <result column="SECONDARY_UOM" property="secondaryUom" jdbcType="VARCHAR"/>
        <result column="BUSINESS_AMOUNT" property="businessAmount" jdbcType="DECIMAL"/>
        <result column="PAYMENT_AMOUNT" property="paymentAmount" jdbcType="DECIMAL"/>
        <result column="MANAGEMENT_AMOUNT" property="managementAmount" jdbcType="DECIMAL"/>
        <result column="REPORT_FUNCTIONAL_AMOUNT" property="reportFunctionalAmount" jdbcType="DECIMAL"/>
        <result column="COMPANY_ID" property="companyId" jdbcType="DECIMAL"/>
        <result column="OPERATION_UNIT_ID" property="operationUnitId" jdbcType="DECIMAL"/>
        <result column="UNIT_ID" property="unitId" jdbcType="DECIMAL"/>

        <result column="LINE_NUMBER" property="lineNumber" jdbcType="DECIMAL"/>
        <result column="SPLITTED_TAX_AMOUNT" property="splittedTaxAmount" jdbcType="DECIMAL"/>
        <result column="PAYMENT_SP_TAX_AMOUNT" property="paymentSpTaxAmount" jdbcType="DECIMAL"/>
        <result column="REPORT_TAX_AMOUNT" property="reportTaxAmount" jdbcType="DECIMAL"/>
        <result column="PAYMENT_RP_TAX_AMOUNT" property="paymentRpTaxAmount" jdbcType="DECIMAL"/>
        <result column="TAX_TYPE_ID" property="taxTypeId" jdbcType="DECIMAL"/>
        <result column="INVOICE_ITEM_ID" property="invoiceItemId" jdbcType="DECIMAL"/>
        <result column="INVOICE_USEDE_ID" property="invoiceUsedeId" jdbcType="DECIMAL"/>
        <result column="UNIT_TYPE_ID" property="unitTypeId" jdbcType="DECIMAL"/>
        <result column="AUTHENTICATION_STATUS" property="authenticationStatus" jdbcType="VARCHAR"/>
        <result column="AUTHENTICATING_FLAG" property="authenticatingFlag" jdbcType="VARCHAR"/>
        <result column="FUNCTIONAL_SP_TAX_AMOUNT" property="functionalSpTaxAmount" jdbcType="DECIMAL"/>
        <result column="FUNCTIONAL_RP_TAX_AMOUNT" property="functionalRpTaxAmount" jdbcType="DECIMAL"/>
    </resultMap>
    <select id="getExpReportDists" resultMap="BaseResultMap">
        SELECT
	      erd.*, erl.line_number,
	      v.splitted_tax_amount,
	      v.payment_sp_tax_amount,
	      v.report_tax_amount,
	      v.payment_rp_tax_amount,
	      eou.unit_type_id
        FROM
	      exp_report_dist erd
        LEFT JOIN exp_report_line erl ON erd.exp_report_line_id = erl.exp_report_line_id
        LEFT JOIN (
	      SELECT
		    vitl.splitted_tax_amount,
		    vitl.payment_sp_tax_amount,
		    vitl.report_tax_amount,
		    vitl.payment_rp_tax_amount,
		    vir.document_dist_id
	      FROM
		    vat_invoice_relation vir
	      LEFT JOIN vat_invoice_rel_tax_ln vitl ON vir.relation_id = vitl.relation_id
	      AND vir.document_category = 'EXP_REPORT'
        ) v ON v.document_dist_id = erd.exp_report_dist_id
        LEFT JOIN exp_org_unit eou ON eou.unit_id = erd.unit_id
      WHERE
        erl.exp_report_header_id = #{expReportHeaderId}
    </select>
    <select id="getExpReportDistsTax" resultMap="BaseResultMap">
        SELECT
	      erd.exp_report_dist_id,
	      erd.acc_entity_id,
	      erd.company_id,
	      erd.position_id,
	      erd.payment_currency_code,
	      erd.description,
	      vitl.tax_type_id,
	      vitl.invoice_item_id,
	      vitl.invoice_usede_id,
	      sum(
		      IFNULL(vitl.splitted_tax_amount, 0)
	          ) splitted_tax_amount,
	      sum(
		      IFNULL(vitl.payment_sp_tax_amount,0)
	          ) payment_sp_tax_amount,
	      sum(
		      IFNULL(vitl.report_tax_amount, 0)
	          ) report_tax_amount,
	      sum(
		      IFNULL(vitl.payment_rp_tax_amount,0)
	          ) payment_rp_tax_amount
        FROM
	      vat_invoice_relation vir
        INNER JOIN vat_invoice_rel_tax_ln vitl ON vir.relation_id = vitl.relation_id
        INNER JOIN exp_report_dist erd ON vir.document_dist_id = erd.exp_report_dist_id
        INNER JOIN (
	        SELECT
		        vn.INVOICE_ID
	        FROM
		        vat_invoice vn
	        LEFT JOIN vat_invoice_category vic ON vn.INVOICE_CATEGORY_ID = vic.INVOICE_CATEGORY_ID
	        AND vic.INVOICE_CATEGORY_CODE = 'VAT-SPECIAL'
        ) v ON v.INVOICE_ID = vir.invoice_id
        WHERE
	      vir.document_category = 'EXP_REPORT'
        AND vir.document_id = #{expReportHeaderId}
        AND vir.invoice_id IS NOT NULL
        AND vir.invoice_line_id IS NOT NULL
        AND vitl.splitted_tax_amount > 0
        GROUP BY
	        erd.exp_report_dist_id,
	        erd.acc_entity_id,
	        erd.company_id,
	        erd.position_id,
	        erd.payment_currency_code,
	        erd.description,
	        vitl.tax_type_id,
	        vitl.invoice_item_id,
	        vitl.invoice_usede_id
        UNION ALL
	    SELECT
		  erd.exp_report_dist_id,
		  erd.acc_entity_id,
		  erd.company_id,
		  erd.position_id,
		  erd.payment_currency_code,
		  erd.description,
		  vitl.tax_type_id,
		  vitl.invoice_item_id,
		  vitl.invoice_usede_id,
		  sum(
			  IFNULL(vitl.splitted_tax_amount, 0)
		  ) splitted_tax_amount,
		  sum(
			  IFNULL(
				vitl.payment_sp_tax_amount,0)
		  ) payment_sp_tax_amount,
		  sum(
			IFNULL(vitl.report_tax_amount, 0)
		  ) report_tax_amount,
		  sum(
			IFNULL(vitl.payment_rp_tax_amount,0)
		  ) payment_rp_tax_amount
	FROM
		vat_invoice_relation vir
	LEFT JOIN vat_invoice_rel_tax_ln vitl ON vir.relation_id = vitl.relation_id
	LEFT JOIN exp_report_dist erd ON vir.document_dist_id = erd.exp_report_dist_id
	WHERE
		vir.document_category = 'EXP_REPORT'
	AND vir.document_id = #{expReportHeaderId}
	AND vir.invoice_id IS NULL
	AND vir.invoice_line_id IS NULL
	AND vitl.splitted_tax_amount > 0
	GROUP BY
		erd.exp_report_dist_id,
		erd.acc_entity_id,
		erd.company_id,
		erd.position_id,
		erd.payment_currency_code,
		erd.description,
		vitl.tax_type_id,
		vitl.invoice_item_id,
		vitl.invoice_usede_id
    </select>

    <select id="getExpReportDistsCertTax" resultMap="BaseResultMap">
        select erd.*,
             vir.document_id,
             vir.document_line_id,
             vir.document_dist_id,
             vitl.splitted_tax_amount,
             vitl.payment_sp_tax_amount,
             vitl.functional_sp_tax_amount,
             vitl.report_tax_amount,
             vitl.payment_rp_tax_amount,
             vitl.functional_rp_tax_amount,
             vitl.tax_type_id,
             vitl.invoice_usede_id,
             vi.AUTHENTICATION_STATUS,
             vic.AUTHENTICATING_FLAG
        from vat_invoice_relation    vir,
             vat_invoice_rel_tax_ln  vitl,
             exp_report_dist         erd,
			 vat_invoice             vi,
             vat_invoice_category    vic
       where  vir.document_category = 'EXP_REPORT'
             and vir.relation_id = vitl.relation_id
             and vir.invoice_id = vi.invoice_id
             and vi.invoice_category_id = vic.invoice_category_id
             and vir.document_dist_id = erd.exp_report_dist_id
             and vir.document_line_id = erd.exp_report_line_id
             and vir.document_id = #{expReportHeaderId}
             and vir.invoice_id is not null
             and vir.invoice_line_id is not null
    </select>
    <update id="batchUpdate">
         update exp_report_dist t
         set t.audit_flag       = #{auditFlag},
             t.audit_date       = #{auditDate},
             t.audit_date_tz    = #{auditDateTime,jdbcType = TIMESTAMP},
             t.audit_date_ltz   = #{auditDateTime,jdbcType = TIMESTAMP},
             t.last_updated_by  = #{request.userId},
             t.last_update_date = current_time
       where exists
             (select 1
                from exp_report_line erl
               where erl.exp_report_header_id = #{expReportHeaderId}
                 and erl.exp_report_line_id = t.exp_report_line_id)
    </update>

    <update id="auditRejectBatchUpdate">
         update exp_report_dist t
         set t.report_status    = #{reportStatus},
             t.audit_flag       = #{auditFlag},
             t.audit_date       = null,
             t.audit_date_tz    = null,
             t.audit_date_ltz   = null,
             t.last_updated_by  = #{request.userId},
             t.last_update_date = current_time
       where exists
             (select 1
                from exp_report_line erl
               where erl.exp_report_header_id = #{expReportHeaderId}
                 and erl.exp_report_line_id = t.exp_report_line_id)
    </update>

    <select id="queryPaymentAmountByHeaderId" resultType="java.math.BigDecimal">
        select (case when sum(d.payment_amount) is null then 0 else sum(d.payment_amount) end)
          from exp_report_line l,
               exp_report_dist d
         where l.exp_report_header_id = #{expReportHeaderId}
               and d.exp_report_line_id = l.exp_report_line_id
    </select>
    <update id="updateStatus">
        update exp_report_dist d
           set d.report_status    = #{reportStatus},
               d.last_updated_by  = #{userId},
               d.last_update_date = current_time
         where d.exp_report_line_id in (select l.exp_report_line_id
                                          from exp_report_line l
                                         where l.exp_report_header_id = #{expReportHeaderId})
    </update>
</mapper>