<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.hand.hec.expm.mapper.ExpReportHeaderMapper">
    <resultMap id="BaseResultMap" type="com.hand.hec.expm.dto.ExpReportHeader">
        <result column="ATTACHMENT_NUM" property="attachmentNum" jdbcType="DECIMAL"/>
        <result column="DESCRIPTION" property="description" jdbcType="VARCHAR"/>
        <result column="WRITE_OFF_STATUS" property="writeOffStatus" jdbcType="VARCHAR"/>
        <result column="WRITE_OFF_COMPLETED_DATE" property="writeOffCompletedDate" jdbcType="TIMESTAMP"/>
        <result column="WRITE_OFF_COMPLETED_DATE_TZ" property="writeOffCompletedDateTz" jdbcType="TIMESTAMP"/>
        <result column="WRITE_OFF_COMPLETED_DATE_LTZ" property="writeOffCompletedDateLtz" jdbcType="TIMESTAMP"/>
        <result column="AMORTIZATION_FLAG" property="amortizationFlag" jdbcType="VARCHAR"/>
        <result column="REVERSED_FLAG" property="reversedFlag" jdbcType="VARCHAR"/>
        <result column="SOURCE_EXP_REP_HEADER_ID" property="sourceExpRepHeaderId" jdbcType="DECIMAL"/>
        <result column="SOURCE_TYPE" property="sourceType" jdbcType="VARCHAR"/>
        <result column="PAYMENT_METHOD_ID" property="paymentMethodId" jdbcType="DECIMAL"/>
        <result column="RELEASE_TYPE" property="releaseType" jdbcType="VARCHAR"/>
        <result column="EXP_REQUISITION_HEADER_ID" property="expRequisitionHeaderId" jdbcType="DECIMAL"/>
        <result column="DIMENSION1_ID" property="dimension1Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION2_ID" property="dimension2Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION3_ID" property="dimension3Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION4_ID" property="dimension4Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION5_ID" property="dimension5Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION6_ID" property="dimension6Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION7_ID" property="dimension7Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION8_ID" property="dimension8Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION9_ID" property="dimension9Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION10_ID" property="dimension10Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION11_ID" property="dimension11Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION12_ID" property="dimension12Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION13_ID" property="dimension13Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION14_ID" property="dimension14Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION15_ID" property="dimension15Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION16_ID" property="dimension16Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION17_ID" property="dimension17Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION18_ID" property="dimension18Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION19_ID" property="dimension19Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION20_ID" property="dimension20Id" jdbcType="DECIMAL"/>
        <result column="VAT_INVOICE_FLAG" property="vatInvoiceFlag" jdbcType="VARCHAR"/>
        <result column="AUTHENTICATING_FLAG" property="authenticatingFlag" jdbcType="VARCHAR"/>
        <result column="DOC_STATUS" property="docStatus" jdbcType="VARCHAR"/>
        <result column="EXP_REPORT_HEADER_ID" property="expReportHeaderId" jdbcType="DECIMAL"/>
        <result column="EXP_REPORT_NUMBER" property="expReportNumber" jdbcType="VARCHAR"/>
        <result column="EXP_REPORT_BARCODE" property="expReportBarcode" jdbcType="VARCHAR"/>
        <result column="COMPANY_ID" property="companyId" jdbcType="DECIMAL"/>
        <result column="OPERATION_UNIT_ID" property="operationUnitId" jdbcType="DECIMAL"/>
        <result column="UNIT_ID" property="unitId" jdbcType="DECIMAL"/>
        <result column="POSITION_ID" property="positionId" jdbcType="DECIMAL"/>
        <result column="EMPLOYEE_ID" property="employeeId" jdbcType="DECIMAL"/>
        <result column="ACC_ENTITY_ID" property="accEntityId" jdbcType="DECIMAL"/>
        <result column="RESP_CENTER_ID" property="respCenterId" jdbcType="DECIMAL"/>
        <result column="BGT_ENTITY_ID" property="bgtEntityId" jdbcType="DECIMAL"/>
        <result column="BGT_CENTER_ID" property="bgtCenterId" jdbcType="DECIMAL"/>
        <result column="PAYEE_CATEGORY" property="payeeCategory" jdbcType="VARCHAR"/>
        <result column="PAYEE_ID" property="payeeId" jdbcType="DECIMAL"/>
        <result column="MO_EXP_REPORT_TYPE_ID" property="moExpReportTypeId" jdbcType="DECIMAL"/>
        <result column="MO_EMP_GROUP_ID" property="moEmpGroupId" jdbcType="DECIMAL"/>
        <result column="PAYMENT_CURRENCY_CODE" property="paymentCurrencyCode" jdbcType="VARCHAR"/>
        <result column="PAY2FUN_EXCHANGE_TYPE" property="pay2funExchangeType" jdbcType="VARCHAR"/>
        <result column="PAY2FUN_EXCHANGE_RATE" property="pay2funExchangeRate" jdbcType="DECIMAL"/>
        <result column="REPORT_DATE" property="reportDate" jdbcType="DATE"/>
        <result column="REPORT_DATE_TZ" property="reportDateTz" jdbcType="TIMESTAMP"/>
        <result column="REPORT_DATE_LTZ" property="reportDateLtz" jdbcType="TIMESTAMP"/>
        <result column="PERIOD_NAME" property="periodName" jdbcType="VARCHAR"/>
        <result column="REPORT_STATUS" property="reportStatus" jdbcType="VARCHAR"/>
        <result column="JE_CREATION_STATUS" property="jeCreationStatus" jdbcType="VARCHAR"/>
        <result column="AUDIT_FLAG" property="auditFlag" jdbcType="VARCHAR"/>
        <result column="AUDIT_DATE" property="auditDate" jdbcType="TIMESTAMP"/>
        <result column="AUDIT_DATE_TZ" property="auditDateTz" jdbcType="TIMESTAMP"/>
        <result column="AUDIT_DATE_LTZ" property="auditDateLtz" jdbcType="TIMESTAMP"/>
        <result column="GLD_INTERFACE_FLAG" property="gldInterfaceFlag" jdbcType="VARCHAR"/>
        <result column="PAYMENT_AMOUNT" property="paymentAmount" jdbcType="VARCHAR"/>
        <result column="BUSINESS_AMOUNT" property="businessAmount" jdbcType="VARCHAR"/>
        <!--非主表字段-->
        <result column="MO_EXP_REPORT_TYPE_NAME" property="moExpReportTypeName" jdbcType="VARCHAR"/>
        <result column="COMPANY_NAME" property="companyName" jdbcType="VARCHAR"/>
        <result column="ACC_ENTITY_NAME" property="accEntityName" jdbcType="VARCHAR"/>
        <result column="RESP_CENTER_NAME" property="respCenterName" jdbcType="VARCHAR"/>
        <result column="EMPLOYEE_NAME" property="employeeName" jdbcType="VARCHAR"/>
        <result column="POSITION_NAME" property="positionName" jdbcType="VARCHAR"/>
        <result column="UNIT_NAME" property="unitName" jdbcType="VARCHAR"/>
        <result column="BGT_ENTITY_NAME" property="bgtEntityName" jdbcType="VARCHAR"/>
        <result column="BGT_CENTER_NAME" property="bgtCenterName" jdbcType="VARCHAR"/>
        <result column="PAYEE_CATEGORY_NAME" property="payeeCategoryName" jdbcType="VARCHAR"/>
        <result column="PAYMENT_CURRENCY_NAME" property="paymentCurrencyName" jdbcType="VARCHAR"/>
        <result column="PAYMENT_CURRENCY_SYMBOL" property="paymentCurrencySymbol" jdbcType="VARCHAR"/>
        <result column="REPORT_STATUS_NAME" property="reportStatusName" jdbcType="VARCHAR"/>
        <result column="TOTAL_PAYMENT_AMOUNT" property="totalPaymentAmount" jdbcType="DECIMAL"/>
        <result column="PAID_AMOUNT" property="paidAmount" jdbcType="DECIMAL"/>
        <result column="TOTAL_PAID_AMOUNT" property="totalPaidAmount" jdbcType="DECIMAL"/>
        <result column="PROGRESS_STATUS" property="progressStatus" jdbcType="VARCHAR"/>
        <result column="PROGRESS_STATUS_NAME" property="progressStatusName" jdbcType="VARCHAR"/>
        <result column="PROGRESS_COUNT" property="progressCount" jdbcType="DECIMAL"/>
        <result column="SERVICE_NAME" property="serviceName" jdbcType="VARCHAR"/>
        <result column="READONLY_SERVICE_NAME" property="readonlyServiceName" jdbcType="VARCHAR"/>
        <result column="INSTANCE_ID" property="instanceId" jdbcType="DECIMAL"/>
        <result column="SET_OF_BOOKS_ID" property="setOfBooksId" jdbcType="DECIMAL"/>
        <result column="EMPLOYEE_TYPE_ID" property="employeeTypeId" jdbcType="DECIMAL"/>
        <result column="FUNCTIONAL_CURRENCY_CODE" property="functionalCurrencyCode" jdbcType="VARCHAR"/>
        <result column="MAG_ORG_ID" property="magOrgId" jdbcType="DECIMAL"/>


        <result column="PAYEE_NAME" property="payeeName" jdbcType="VARCHAR"/>
        <result column="ACCOUNT_NAME" property="accountName" jdbcType="VARCHAR"/>
        <result column="ACCOUNT_NUMBER" property="accountNumber" jdbcType="VARCHAR"/>
        <result column="BACK_NAME" property="backName" jdbcType="VARCHAR"/>
        <result column="BACK_CODE" property="backCode" jdbcType="VARCHAR"/>
        <result column="BANK_LOCATION_NAME" property="bankLocationName" jdbcType="VARCHAR"/>
        <result column="BANK_LOCATION_CODE" property="bankLocationCode" jdbcType="VARCHAR"/>
        <result column="PROVINCE_NAME" property="provinceName" jdbcType="VARCHAR"/>
        <result column="PROVINCE_CODE" property="provinceCode" jdbcType="VARCHAR"/>
        <result column="CITY_NAME" property="cityName" jdbcType="VARCHAR"/>
        <result column="CITY_CODE" property="cityCode" jdbcType="VARCHAR"/>
        <result column="PAYMENT_CURRENCY_PRECISION" property="paymentCurrencyPrecision" jdbcType="VARCHAR"/>
        <result column="PAY2FUN_EXCHANGE_TYPE_NAME" property="pay2funExchangeTypeName" jdbcType="VARCHAR"/>
        <result column="MANAGEMENT_CURRENCY_CODE" property="managementCurrencyCode" jdbcType="VARCHAR"/>
        <result column="MANAGEMENT_CURRENCY_NAME" property="managementCurrencyName" jdbcType="VARCHAR"/>
        <result column="MANAGEMENT_CURRENCY_PRECISION" property="managementCurrencyPrecision" jdbcType="DECIMAL"/>
        <result column="PAY2MAG_EXCHANGE_TYPE" property="pay2magExchangeType" jdbcType="VARCHAR"/>
        <result column="PAY2MAG_EXCHANGE_TYPE_NAME" property="pay2magExchangeTypeName" jdbcType="VARCHAR"/>
        <result column="PAY2MAG_EXCHANGE_RATE" property="pay2magExchangeRate" jdbcType="DECIMAL"/>
        <result column="FUNCTIONAL_CURRENCY_NAME" property="functionalCurrencyName" jdbcType="VARCHAR"/>
        <result column="FUNCTIONAL_CURRENCY_PRECISION" property="functionalCurrencyPrecision" jdbcType="DECIMAL"/>
        <result column="PAYMENT_TYPE_ID" property="paymentTypeId" jdbcType="DECIMAL"/>
        <result column="PAYMENT_TYPE_NAME" property="paymentTypeName" jdbcType="VARCHAR"/>
        <result column="PAYMENT_USEDE_ID" property="paymentUsedeId" jdbcType="DECIMAL"/>
        <result column="PAYMENT_USEDE_NAME" property="paymentUsedeName" jdbcType="VARCHAR"/>
        <result column="CREATED_BY_NAME" property="createdByName" jdbcType="VARCHAR"/>
        <result column="PAYMENT_METHOD_NAME" property="paymentMethodName" jdbcType="VARCHAR"/>
        <result column="DIMENSION1_NAME" property="dimension1Name" jdbcType="VARCHAR"/>
        <result column="DIMENSION2_NAME" property="dimension2Name" jdbcType="VARCHAR"/>
        <result column="DIMENSION3_NAME" property="dimension3Name" jdbcType="VARCHAR"/>
        <result column="DIMENSION4_NAME" property="dimension4Name" jdbcType="VARCHAR"/>
        <result column="DIMENSION5_NAME" property="dimension5Name" jdbcType="VARCHAR"/>
        <result column="DIMENSION6_NAME" property="dimension6Name" jdbcType="VARCHAR"/>
        <result column="DIMENSION7_NAME" property="dimension7Name" jdbcType="VARCHAR"/>
        <result column="DIMENSION8_NAME" property="dimension8Name" jdbcType="VARCHAR"/>
        <result column="DIMENSION9_NAME" property="dimension9Name" jdbcType="VARCHAR"/>
        <result column="DIMENSION10_NAME" property="dimension10Name" jdbcType="VARCHAR"/>
        <result column="DIMENSION11_NAME" property="dimension11Name" jdbcType="VARCHAR"/>
        <result column="DIMENSION12_NAME" property="dimension12Name" jdbcType="VARCHAR"/>
        <result column="DIMENSION13_NAME" property="dimension13Name" jdbcType="VARCHAR"/>
        <result column="DIMENSION14_NAME" property="dimension14Name" jdbcType="VARCHAR"/>
        <result column="DIMENSION15_NAME" property="dimension15Name" jdbcType="VARCHAR"/>
        <result column="DIMENSION16_NAME" property="dimension16Name" jdbcType="VARCHAR"/>
        <result column="DIMENSION17_NAME" property="dimension17Name" jdbcType="VARCHAR"/>
        <result column="DIMENSION18_NAME" property="dimension18Name" jdbcType="VARCHAR"/>
        <result column="DIMENSION19_NAME" property="dimension19Name" jdbcType="VARCHAR"/>
        <result column="DIMENSION20_NAME" property="dimension20Name" jdbcType="VARCHAR"/>
        <result column="RELATION_METHOD_CODE" property="relationMethodCode" jdbcType="VARCHAR"/>
        <result column="REQ_REQUIRED_FLAG" property="reqRequiredFlag" jdbcType="VARCHAR"/>
        <result column="REQ_REQUIRED" property="reqRequired" jdbcType="VARCHAR"/>
        <result column="EXP_REQUISITION_NUMBER" property="expRequisitionNumber" jdbcType="VARCHAR"/>
        <result column="TAXPAYER_TYPE" property="taxpayerType" jdbcType="VARCHAR"/>
        <result column="DOC_ID" property="docId" jdbcType="DECIMAL"/>
        <result column="REF_DOC_CATEGORY" property="refDocCategory" jdbcType="VARCHAR"/>
        <result column="REP_TOTAL_AMOUNT" property="repTotalAmount" jdbcType="DECIMAL"/>
        <result column="MONOPOLIZE_FLAG" property="monopolizeFlag" jdbcType="VARCHAR"/>
        <result column="REQ_READONLY_SERVICE_NAME" property="reqReadonlyServiceName" jdbcType="VARCHAR"/>
        <result column="ADJUSTMENT_FLAG" property="adjustmentFlag" jdbcType="VARCHAR"/>
        <result column="AUTO_APPROVE_FLAG" property="autoApproveFlag" jdbcType="VARCHAR"/>
        <result column="REPORT_NAME" property="reportName" jdbcType="VARCHAR"/>
    </resultMap>
    <select id="queryExpReportMain" resultMap="BaseResultMap" parameterType="com.hand.hec.expm.dto.ExpReportHeader">
        SELECT
        h.exp_report_header_id AS exp_report_header_id,
        h.mo_exp_report_type_id AS mo_exp_report_type_id,
        (SELECT
        emrtt.description
        FROM
        exp_mo_report_type emrt
        LEFT JOIN exp_mo_report_type_tl emrtt ON emrt.mo_exp_report_type_id = emrtt.mo_exp_report_type_id AND emrtt.lang
        = #{request.locale}
        WHERE emrt.mo_exp_report_type_id = h.mo_exp_report_type_id) AS mo_exp_report_type_name,
        h.exp_report_number,
        h.company_id,
        (SELECT
        fct.company_short_name
        FROM
        fnd_company fc
        LEFT JOIN fnd_company_tl fct ON fc.company_id = fct.company_id AND fct.lang = #{request.locale}
        WHERE fc.company_id = h.company_id) AS company_name,
        h.acc_entity_id,
        (SELECT
        gaet.acc_entity_name
        FROM
        gld_accounting_entity gae
        LEFT JOIN gld_accounting_entity_tl gaet ON gae.acc_entity_id = gaet.acc_entity_id AND gaet.lang =
        #{request.locale}
        WHERE gae.acc_entity_id = h.acc_entity_id) AS acc_entity_name,
        h.resp_center_id,
        (SELECT
        grc.responsibility_center_name
        FROM
        gld_responsibility_center grc
        LEFT JOIN gld_responsibility_center_tl grct ON grc.responsibility_center_id = grct.responsibility_center_id AND
        grct.lang = #{request.locale}
        WHERE grc.responsibility_center_id = h.resp_center_id) AS resp_center_name,
        h.employee_id,
        (SELECT
        ee.NAME
        FROM
        exp_employee ee
        WHERE
        ee.employee_id = h.employee_id) AS employee_name,
        h.position_id,
        (SELECT
        eopt.description
        FROM
        exp_org_position eop
        LEFT JOIN exp_org_position_tl eopt ON eop.position_id = eopt.position_id AND eopt.lang = #{request.locale}
        WHERE eop.position_id = h.position_id) AS position_name,
        h.unit_id,
        (SELECT
        eout.description
        FROM
        exp_org_unit eou
        LEFT JOIN exp_org_unit_tl eout ON eou.unit_id = eout.unit_id AND eout.lang = #{request.locale}
        WHERE eou.unit_id = h.unit_id) AS unit_name,
        h.bgt_entity_id,
        (SELECT
        bet.description
        FROM
        bgt_entity be
        LEFT JOIN bgt_entity_tl bet ON be.entity_id = bet.entity_id AND bet.lang = #{request.locale}
        WHERE be.entity_id = h.bgt_entity_id) AS bgt_entity_name,
        h.bgt_center_id,
        (SELECT
        bct.description
        FROM
        bgt_center bc
        LEFT JOIN bgt_center_tl bct ON bc.center_id = bct.center_id AND bct.lang = #{request.locale}
        WHERE bc.center_id = h.bgt_center_id) AS bgt_center_name,
        h.report_date,
        h.payee_category,
        (SELECT
        scv.MEANING
        FROM
        sys_code_value_b scv
        LEFT JOIN sys_code_b sc ON scv.code_id = sc.code_id
        WHERE scv.VALUE = h.payee_category
        AND sc.CODE = 'PAYMENT_OBJECT') AS payee_category_name,
        h.payee_id,
        h.payment_currency_code,
        (SELECT
        gct.currency_name
        FROM
        gld_currency gc
        LEFT JOIN gld_currency_tl gct ON gc.currency_id = gct.currency_id AND gct.lang = #{request.locale}
        WHERE
        gc.currency_code = h.payment_currency_code) AS payment_currency_name,
        (SELECT
        gc.currency_symbol
        FROM
        gld_currency gc
        WHERE
        gc.currency_code = h.payment_currency_code) AS payment_currency_symbol,
        h.report_status,
        (SELECT
        scv.MEANING
        FROM
        sys_code_value_b scv
        LEFT JOIN sys_code_b sc ON scv.code_id = sc.code_id
        WHERE
        sc.CODE = 'EXP_EXPENSE_REPORT_STATUS'
        AND scv.VALUE = h.report_status) AS report_status_name,
        h.description,
        (SELECT
        (case when SUM(payment_amount) is null then 0 else SUM(payment_amount) end)
        FROM
        exp_report_line l
        WHERE
        l.exp_report_header_id = h.exp_report_header_id
        ) AS total_payment_amount,
        (( SELECT
        ( CASE WHEN sum( cwo.csh_write_off_amount ) IS NULL THEN 0 ELSE sum( cwo.csh_write_off_amount ) END )
        FROM
        csh_write_off cwo
        WHERE
        cwo.document_source = 'EXPENSE_REPORT'
        AND cwo.document_header_id = h.exp_report_header_id
        ) + (
        SELECT
        ( CASE WHEN sum( l.tax_amount ) IS NULL THEN 0 ELSE sum( l.tax_amount ) END )
        FROM
        exp_report_pmt_schedule s
        LEFT JOIN exp_report_pmt_sch_tax_line l ON s.payment_schedule_line_id = l.payment_schedule_line_id
        WHERE
        s.exp_report_header_id = h.exp_report_header_id
        )) AS paid_amount,
        (SELECT
        ( CASE WHEN sum( w.document_write_off_amount ) IS NULL THEN 0 ELSE sum( w.document_write_off_amount ) END )
        FROM
        csh_write_off w
        WHERE
        w.document_source = 'EXPENSE_REPORT'
        AND w.document_header_id = h.exp_report_header_id) AS total_paid_amount,
        h.audit_flag,
        h.reversed_flag,
        null AS progress_status,
        null AS progress_status_name,
        null AS progress_count,
        (select srb.url
        from sys_resource_b srb
        where exists(select 1
        from exp_report_page_element pe
        where pe.service_id = srb.resource_id
        and exists (select 1
        from exp_mo_rep_type_ref_ele e
        where e.report_page_element_id = pe.report_page_element_id
        and e.mo_exp_report_type_id = h.mo_exp_report_type_id
        and e.enabled_flag = 'Y'
        and e.doc_type_code = 'HEADER')
        and pe.enabled_flag = 'Y')) service_name,
        (select srb.url
        from sys_resource_b srb
        where exists(select 1
        from exp_report_page_element pe
        where pe.readonly_service_id = srb.resource_id
        and exists (select 1
        from exp_mo_rep_type_ref_ele e
        where e.report_page_element_id = pe.report_page_element_id
        and e.mo_exp_report_type_id = h.mo_exp_report_type_id
        and e.enabled_flag = 'Y'
        and e.doc_type_code = 'HEADER')
        and pe.enabled_flag = 'Y')) readonly_service_name,
        null instance_id,
        (select emrt.auto_approve_flag from exp_mo_report_type emrt where emrt.mo_exp_report_type_id = h.mo_exp_report_type_id) auto_approve_flag,
        (select emrt.report_name from exp_mo_report_type emrt where emrt.mo_exp_report_type_id = h.mo_exp_report_type_id) report_name
        FROM
        exp_report_header h
        <where>
            <include refid="queryCondition"/>
        </where>
        ORDER BY
        report_date DESC,exp_report_header_id DESC
    </select>
    <sql id="queryCondition">
        h.company_id = #{request.companyId} AND
        h.reversed_flag!='R' AND
        h.created_by = #{request.userId}
        <if test="reportDateFrom!=null">
            AND h.report_date &gt;= #{reportDateFrom}
        </if>
        <if test="reportDateTo!=null">
            AND h.report_date &lt;= #{reportDateTo}
        </if>
        <if test="expReportDateScope!=null and ''!=expReportDateScope">
            AND h.report_date &gt;= #{creationDate}
        </if>
        <if test="expReportNumber!=null and ''!=expReportNumber">
            AND h.exp_report_number like CONCAT('%',#{expReportNumber},'%')
        </if>
        <if test="moExpReportTypeId!=null">
            AND h.mo_exp_report_type_id = #{moExpReportTypeId}
        </if>
        <if test="amountFrom!=null">
            AND (SELECT (case when SUM(payment_amount) is null then 0 else SUM(payment_amount) end) FROM exp_report_line
            l WHERE l.exp_report_header_id =
            h.exp_report_header_id ) &gt;= #{@amountFrom}
        </if>
        <if test="amountTo!=null">
            AND (SELECT (case when SUM(payment_amount) is null then 0 else SUM(payment_amount) end) FROM exp_report_line
            l WHERE l.exp_report_header_id =
            h.exp_report_header_id ) &lt;= #{@amountTo}
        </if>
        <if test="paymentCurrencyCode!=null and ''!=paymentCurrencyCode">
            AND h.payment_currency_code = #{paymentCurrencyCode}
        </if>
        <if test="payeeCategory!=null and ''!=payeeCategory">
            AND h.payee_category = #{@payeeCategory}
        </if>
        <if test="payeeId!=null">
            AND h.payee_id = #{payeeId}
        </if>
        <if test="createdDateFrom!=null">
            AND h.report_date &gt;= #{createdDateFrom}
        </if>
        <if test="createdDateTo!=null">
            AND h.report_date &lt;= #{createdDateTo}
        </if>
        <if test="description!=null and ''!=description">
            AND h.description like CONCAT('%',#{description},'%')
        </if>
    </sql>
    <select id="getExpReportHeader" resultMap="BaseResultMap">
      select
           v.exp_report_header_id,
           v.company_id,
           v.acc_entity_id,
           v.employee_id,
           v.mo_emp_group_id,
           v.mo_exp_report_type_id,
           v.description,
           fc.MAG_ORG_ID,
           v1.set_of_books_id,
           v.position_id,
           v.resp_center_id,
           ee.employee_type_id,
	       v1.FUNCTIONAL_CURRENCY_CODE
      from exp_report_header v LEFT JOIN fnd_company fc ON v.COMPANY_ID = fc.COMPANY_ID
      LEFT JOIN (
	      SELECT
		      gae.ACC_ENTITY_ID,
		      rs.SET_OF_BOOKS_ID,
		  CASE
	      WHEN gae.FUNCTIONAL_CURRENCY_CODE IS NULL THEN
		       gsob.FUNCTIONAL_CURRENCY_CODE else gae.FUNCTIONAL_CURRENCY_CODE
	      END FUNCTIONAL_CURRENCY_CODE
	      FROM
		      gld_accounting_entity gae
	      LEFT JOIN gld_acc_entity_ref_sob rs ON rs.ACC_ENTITY_ID = gae.ACC_ENTITY_ID
	      AND rs.DEFAULT_FLAG = 'Y'
	      LEFT JOIN gld_set_of_book gsob ON gsob.SET_OF_BOOKS_ID = rs.SET_OF_BOOKS_ID
      ) v1 ON v.ACC_ENTITY_ID = v1.ACC_ENTITY_ID
      LEFT JOIN exp_employee ee ON v.employee_id = ee.employee_id
      where v.exp_report_header_id = #{expReportHeaderId}
    </select>

    <select id="auditQuery" resultMap="BaseResultMap">
        SELECT
        h.exp_report_header_id,
        h.exp_report_number,
        h.acc_entity_id,
        gaet.ACC_ENTITY_NAME,
        h.mo_exp_report_type_id,
        emrtt.DESCRIPTION mo_exp_report_type_name,
        h.employee_id,
        ee.`NAME` employee_name,
        h.payment_currency_code,
        v.CURRENCY_NAME payment_currency_name,
        h.payment_amount,
        h.report_date,
        h.report_status,
        v1.MEANING report_status_name,
        h.description,
        h.je_creation_status,
        h.amortization_flag
        FROM
        exp_report_header h
        LEFT JOIN exp_employee ee ON h.EMPLOYEE_ID = ee.EMPLOYEE_ID
        LEFT JOIN gld_accounting_entity_tl gaet ON h.ACC_ENTITY_ID = gaet.ACC_ENTITY_ID AND gaet.LANG =
        #{request.locale,jdbcType = VARCHAR}
        LEFT JOIN exp_mo_report_type_tl emrtt ON h.MO_EXP_REPORT_TYPE_ID = emrtt.MO_EXP_REPORT_TYPE_ID AND emrtt.LANG =
        #{request.locale,jdbcType = VARCHAR}
        LEFT JOIN (
        SELECT
        gc.CURRENCY_CODE,
        gct.CURRENCY_NAME
        FROM
        gld_currency gc
        LEFT JOIN gld_currency_tl gct ON gc.CURRENCY_ID = gct.CURRENCY_ID
        AND gct.LANG = #{request.locale,jdbcType = VARCHAR}
        ) v ON v.CURRENCY_CODE = h.PAYMENT_CURRENCY_CODE
        LEFT JOIN (
        SELECT
        scvb.`VALUE`,
        scvt.MEANING
        FROM
        sys_code_b scb
        INNER JOIN sys_code_value_b scvb ON scb.CODE_ID = scvb.CODE_ID
        INNER JOIN sys_code_value_tl scvt ON scvb.CODE_VALUE_ID = scvt.CODE_VALUE_ID AND scvt.LANG =
        #{request.locale,jdbcType = VARCHAR}
        AND scb.`CODE` = 'EXP_EXPENSE_REPORT_STATUS'
        ) v1 ON v1.`VALUE` = h.REPORT_STATUS
        WHERE h.acc_entity_id = #{accEntityId}
        AND h.report_status = 'COMPLETELY_APPROVED'
        AND h.audit_flag = 'N'
        -- AND
        -- EXISTS
        -- (SELECT
        -- 1
        -- FROM
        -- ssc_task_pool_local l
        -- WHERE
        -- l.doc_category = 'EXP_REPORT' AND
        -- l.doc_id = h.exp_report_header_id
        -- )
        <if test="expReportNumber!=null and ''!=expReportNumber">
            AND h.exp_report_number like CONCAT('%',#{expReportNumber},'%')
        </if>
        <if test="moExpReportTypeId!=null">
            AND h.mo_exp_report_type_id = #{moExpReportTypeId}
        </if>
        <if test="paymentCurrencyCode!=null and ''!=paymentCurrencyCode">
            AND h.payment_currency_code = #{paymentCurrencyCode}
        </if>
        <if test="employeeId != null">
            AND h.employee_id = #{employeeId}
        </if>
        <if test="reportDateFrom!=null">
            AND h.report_date &gt;= #{reportDateFrom}
        </if>
        <if test="reportDateTo!=null">
            AND h.report_date &lt;= #{reportDateTo}
        </if>
        ORDER BY exp_report_number
    </select>

    <select id="reverseQuery" resultMap="BaseResultMap">
        SELECT
        h.exp_report_header_id,
        h.exp_report_number,
        h.acc_entity_id,
        gaet.ACC_ENTITY_NAME,
        h.mo_exp_report_type_id,
        emrtt.DESCRIPTION mo_exp_report_type_name,
        h.employee_id,
        ee.`NAME` employee_name,
        h.payment_currency_code,
        v.CURRENCY_NAME payment_currency_name,
        h.payment_amount,
        h.report_date,
        h.report_status,
        v1.MEANING report_status_name,
        h.description,
        h.je_creation_status,
        h.amortization_flag,
        h.business_amount
        FROM
        exp_report_header h
        LEFT JOIN exp_employee ee ON h.EMPLOYEE_ID = ee.EMPLOYEE_ID
        LEFT JOIN gld_accounting_entity_tl gaet ON h.ACC_ENTITY_ID = gaet.ACC_ENTITY_ID AND gaet.LANG =
        #{request.locale,jdbcType = VARCHAR}
        LEFT JOIN exp_mo_report_type_tl emrtt ON h.MO_EXP_REPORT_TYPE_ID = emrtt.MO_EXP_REPORT_TYPE_ID AND emrtt.LANG =
        #{request.locale,jdbcType = VARCHAR}
        LEFT JOIN (
        SELECT
        gc.CURRENCY_CODE,
        gct.CURRENCY_NAME
        FROM
        gld_currency gc
        LEFT JOIN gld_currency_tl gct ON gc.CURRENCY_ID = gct.CURRENCY_ID
        AND gct.LANG = #{request.locale,jdbcType = VARCHAR}
        ) v ON v.CURRENCY_CODE = h.PAYMENT_CURRENCY_CODE
        LEFT JOIN (
        SELECT
        scvb.`VALUE`,
        scvt.MEANING
        FROM
        sys_code_b scb
        INNER JOIN sys_code_value_b scvb ON scb.CODE_ID = scvb.CODE_ID
        INNER JOIN sys_code_value_tl scvt ON scvb.CODE_VALUE_ID = scvt.CODE_VALUE_ID AND scvt.LANG =
        #{request.locale,jdbcType = VARCHAR}
        AND scb.`CODE` = 'EXP_EXPENSE_REPORT_STATUS'
        ) v1 ON v1.`VALUE` = h.REPORT_STATUS
        WHERE h.company_id = #{request.companyId} AND
        h.reversed_flag = 'N' AND
        h.audit_flag = 'Y' AND
        h.write_off_status = 'N' AND
        h.report_status = 'COMPLETELY_APPROVED'
        <if test="expReportNumber!=null and ''!=expReportNumber">
            AND h.exp_report_number like CONCAT('%',#{expReportNumber},'%')
        </if>
        <if test="moExpReportTypeId!=null">
            AND h.mo_exp_report_type_id = #{moExpReportTypeId}
        </if>
        <if test="paymentCurrencyCode!=null and ''!=paymentCurrencyCode">
            AND h.payment_currency_code = #{paymentCurrencyCode}
        </if>
        <if test="employeeId != null">
            AND h.employee_id = #{employeeId}
        </if>
        <if test="reportDateFrom!=null">
            AND h.report_date &gt;= #{reportDateFrom}
        </if>
        <if test="reportDateTo!=null">
            AND h.report_date &lt;= #{reportDateTo}
        </if>
        ORDER BY exp_report_number
    </select>
    <select id="expReportHeaderQuery" resultMap="BaseResultMap">
        SELECT
            h.exp_report_header_id,
            h.mo_exp_report_type_id,
            (SELECT emrtt.description FROM exp_mo_report_type emrt LEFT JOIN exp_mo_report_type_tl emrtt ON emrt.MO_EXP_REPORT_TYPE_ID = emrtt.MO_EXP_REPORT_TYPE_ID AND emrtt.LANG = #{request.locale} WHERE emrt.MO_EXP_REPORT_TYPE_ID = h.mo_exp_report_type_id) AS mo_exp_report_type_name,
            h.exp_report_number,
            h.amortization_flag,
            h.company_id,
            (SELECT fct.company_short_name FROM fnd_company fc LEFT JOIN fnd_company_tl fct ON fc.company_id = fct.company_id and fct.LANG = #{request.locale} where fc.COMPANY_ID = h.company_id) AS company_name,
            h.acc_entity_id,
            (SELECT gaet.acc_entity_name FROM gld_accounting_entity gae LEFT JOIN gld_accounting_entity_tl gaet ON gae.ACC_ENTITY_ID = gaet.ACC_ENTITY_ID  AND gaet.LANG = #{request.locale} where gae.ACC_ENTITY_ID = h.acc_entity_id) AS acc_entity_name,
            h.resp_center_id,
            (SELECT grct.responsibility_center_name FROM gld_responsibility_center grc LEFT JOIN gld_responsibility_center_tl grct ON grc.RESPONSIBILITY_CENTER_ID = grct.RESPONSIBILITY_CENTER_ID AND grct.LANG = #{request.locale} where grct.RESPONSIBILITY_CENTER_ID = h.resp_center_id) AS resp_center_name,
            h.employee_id,
            (select ee.name from exp_employee ee where ee.employee_id = h.employee_id) AS employee_name,
            h.position_id,
            (SELECT eopt.description FROM exp_org_position eop LEFT JOIN exp_org_position_tl eopt ON eop.position_id = eopt.position_id AND eopt.lang = #{request.locale} WHERE eop.position_id = h.position_id) AS position_name,
            h.unit_id,
            (SELECT eout.description FROM exp_org_unit eou LEFT JOIN exp_org_unit_tl eout ON eou.unit_id = eout.unit_id AND eout.lang = #{request.locale} WHERE eou.unit_id = h.unit_id) AS unit_name,
            h.bgt_entity_id,
            (SELECT bet.description FROM bgt_entity be LEFT JOIN bgt_entity_tl bet ON be.entity_id = bet.entity_id AND bet.lang = #{request.locale} WHERE be.entity_id = h.bgt_entity_id) AS bgt_entity_name,
            h.bgt_center_id,
            (SELECT bct.description FROM bgt_center bc LEFT JOIN bgt_center_tl bct ON bc.center_id = bct.center_id AND bct.lang = #{request.locale} WHERE bc.center_id = h.bgt_center_id) AS bgt_center_name,
            h.report_date,
            h.period_name,
            h.payee_category,
            (SELECT scv.MEANING FROM sys_code_value_b scv LEFT JOIN sys_code_b sc ON scv.code_id = sc.code_id WHERE scv.VALUE = h.payee_category AND sc.CODE = 'PAYMENT_OBJECT') AS payee_category_name,
            h.payee_id,
            NULL AS payee_name,
            NULL AS account_name,
            NULL AS account_number,
            NULL AS bank_name,
            NULL AS back_code,
            NULL AS bank_location_name,
            NULL AS bank_location_code,
            NULL AS province_name,
            NULL AS province_code,
            NULL AS city_name,
            NULL AS city_code,
            h.payment_currency_code,
            (SELECT gct.currency_name FROM gld_currency gc LEFT JOIN gld_currency_tl gct ON gc.currency_id = gct.currency_id AND gct.lang = #{request.locale} WHERE gc.currency_code = h.payment_currency_code) AS payment_currency_name,
            (SELECT gc.finance_precision FROM gld_currency gc where gc.currency_code = h.payment_currency_code) AS payment_currency_precision,
            h.pay2fun_exchange_type,
            (SELECT gett.description FROM gld_exchangerate_type ge LEFT JOIN gld_exchangerate_type_tl gett ON ge.TYPE_ID = gett.TYPE_ID AND gett.LANG = #{request.locale} where ge.TYPE_CODE = h.pay2fun_exchange_type) AS pay2fun_exchange_type_name,
            NULL AS pay2fun_exchange_rate,
            (select fc.managing_currency from fnd_company fc where fc.company_id = h.company_id) AS management_currency_code,
            NULL AS management_currency_name,
            NULL AS management_currency_precision,
            NULL AS pay2mag_exchange_type,
            NULL AS pay2mag_exchange_type_name,
            NULL AS pay2mag_exchange_rate,
            NULL AS functional_currency_code,
            NULL AS functional_currency_name,
            NULL AS functional_currency_precision,
            h.audit_flag,
            h.audit_date,
            h.audit_date_tz,
            h.audit_date_ltz,
            (select rt.payment_method_id from exp_mo_report_type rt where rt.mo_exp_report_type_id = h.mo_exp_report_type_id) AS payment_type_id,
            (SELECT cpmt.description FROM csh_payment_method cpm LEFT JOIN csh_payment_method_tl cpmt ON cpm.PAYMENT_METHOD_ID = cpmt.PAYMENT_METHOD_ID AND cpmt.LANG = #{request.locale} WHERE cpm.payment_method_id = (select payment_method_id from exp_mo_report_type rt where rt.mo_exp_report_type_id = h.mo_exp_report_type_id)) AS payment_type_name,
            (select ud.usedes_id from exp_mo_rep_type_ref_pay_ud ud where ud.mo_exp_report_type_id = h.mo_exp_report_type_id and ud.default_flag = 'Y' and ud.enabled_flag = 'Y') AS payment_usede_id,
            (SELECT cmut.description FROM csh_mo_payment_used cmu LEFT JOIN csh_mo_payment_used_tl cmut ON cmu.payment_usede_id = cmut.payment_usede_id AND cmut.LANG = #{request.locale} WHERE cmu.payment_usede_id = (select ud.usedes_id from exp_mo_rep_type_ref_pay_ud ud where ud.mo_exp_report_type_id = h.mo_exp_report_type_id and ud.default_flag = 'Y' and ud.enabled_flag = 'Y')) AS payment_usede_name,
            h.report_status,
            (SELECT scv.meaning FROM sys_code_value_b scv LEFT JOIN sys_code_b sc ON scv.code_id = sc.code_id  WHERE scv.VALUE = h.report_status AND sc.CODE = 'EXP_EXPENSE_REPORT_STATUS') AS report_status_name,
            (select ee.name from exp_employee ee left join sys_user su on su.employee_id = ee.employee_id where su.user_id = h.created_by) AS created_by_name,
            h.payment_method_id,
            (SELECT cpmt.description FROM csh_payment_method cpm LEFT JOIN csh_payment_method_tl cpmt ON cpm.PAYMENT_METHOD_ID = cpmt.PAYMENT_METHOD_ID and cpmt.LANG = #{request.locale} where cpm.payment_method_id = h.payment_method_id) AS payment_method_name,
            h.dimension1_id,
            h.dimension2_id,
            h.dimension3_id,
            h.dimension4_id,
            h.dimension5_id,
            h.dimension6_id,
            h.dimension7_id,
            h.dimension8_id,
            h.dimension9_id,
            h.dimension10_id,
            h.dimension11_id,
            h.dimension12_id,
            h.dimension13_id,
            h.dimension14_id,
            h.dimension15_id,
            h.dimension16_id,
            h.dimension17_id,
            h.dimension18_id,
            h.dimension19_id,
            h.dimension20_id,
            (SELECT fdvt.description FROM fnd_dimension_value fdv LEFT JOIN fnd_dimension_value_tl fdvt ON fdv.DIMENSION_VALUE_ID = fdvt.DIMENSION_VALUE_ID AND fdvt.LANG = #{request.locale} where fdv.DIMENSION_VALUE_ID = h.dimension1_id) AS dimension1_name,
            (SELECT fdvt.description FROM fnd_dimension_value fdv LEFT JOIN fnd_dimension_value_tl fdvt ON fdv.DIMENSION_VALUE_ID = fdvt.DIMENSION_VALUE_ID AND fdvt.LANG = #{request.locale} where fdv.DIMENSION_VALUE_ID = h.dimension2_id) AS dimension2_name,
            (SELECT fdvt.description FROM fnd_dimension_value fdv LEFT JOIN fnd_dimension_value_tl fdvt ON fdv.DIMENSION_VALUE_ID = fdvt.DIMENSION_VALUE_ID AND fdvt.LANG = #{request.locale} where fdv.DIMENSION_VALUE_ID = h.dimension3_id) AS dimension3_name,
            (SELECT fdvt.description FROM fnd_dimension_value fdv LEFT JOIN fnd_dimension_value_tl fdvt ON fdv.DIMENSION_VALUE_ID = fdvt.DIMENSION_VALUE_ID AND fdvt.LANG = #{request.locale} where fdv.DIMENSION_VALUE_ID = h.dimension4_id) AS dimension4_name,
            (SELECT fdvt.description FROM fnd_dimension_value fdv LEFT JOIN fnd_dimension_value_tl fdvt ON fdv.DIMENSION_VALUE_ID = fdvt.DIMENSION_VALUE_ID AND fdvt.LANG = #{request.locale} where fdv.DIMENSION_VALUE_ID = h.dimension5_id) AS dimension5_name,
            (SELECT fdvt.description FROM fnd_dimension_value fdv LEFT JOIN fnd_dimension_value_tl fdvt ON fdv.DIMENSION_VALUE_ID = fdvt.DIMENSION_VALUE_ID AND fdvt.LANG = #{request.locale} where fdv.DIMENSION_VALUE_ID = h.dimension6_id) AS dimension6_name,
            (SELECT fdvt.description FROM fnd_dimension_value fdv LEFT JOIN fnd_dimension_value_tl fdvt ON fdv.DIMENSION_VALUE_ID = fdvt.DIMENSION_VALUE_ID AND fdvt.LANG = #{request.locale} where fdv.DIMENSION_VALUE_ID = h.dimension7_id) AS dimension7_name,
            (SELECT fdvt.description FROM fnd_dimension_value fdv LEFT JOIN fnd_dimension_value_tl fdvt ON fdv.DIMENSION_VALUE_ID = fdvt.DIMENSION_VALUE_ID AND fdvt.LANG = #{request.locale} where fdv.DIMENSION_VALUE_ID = h.dimension8_id) AS dimension8_name,
            (SELECT fdvt.description FROM fnd_dimension_value fdv LEFT JOIN fnd_dimension_value_tl fdvt ON fdv.DIMENSION_VALUE_ID = fdvt.DIMENSION_VALUE_ID AND fdvt.LANG = #{request.locale} where fdv.DIMENSION_VALUE_ID = h.dimension9_id) AS dimension9_name,
            (SELECT fdvt.description FROM fnd_dimension_value fdv LEFT JOIN fnd_dimension_value_tl fdvt ON fdv.DIMENSION_VALUE_ID = fdvt.DIMENSION_VALUE_ID AND fdvt.LANG = #{request.locale} where fdv.DIMENSION_VALUE_ID = h.dimension10_id) AS dimension10_name,
            (SELECT fdvt.description FROM fnd_dimension_value fdv LEFT JOIN fnd_dimension_value_tl fdvt ON fdv.DIMENSION_VALUE_ID = fdvt.DIMENSION_VALUE_ID AND fdvt.LANG = #{request.locale} where fdv.DIMENSION_VALUE_ID = h.dimension11_id) AS dimension11_name,
            (SELECT fdvt.description FROM fnd_dimension_value fdv LEFT JOIN fnd_dimension_value_tl fdvt ON fdv.DIMENSION_VALUE_ID = fdvt.DIMENSION_VALUE_ID AND fdvt.LANG = #{request.locale} where fdv.DIMENSION_VALUE_ID = h.dimension12_id) AS dimension12_name,
            (SELECT fdvt.description FROM fnd_dimension_value fdv LEFT JOIN fnd_dimension_value_tl fdvt ON fdv.DIMENSION_VALUE_ID = fdvt.DIMENSION_VALUE_ID AND fdvt.LANG = #{request.locale} where fdv.DIMENSION_VALUE_ID = h.dimension13_id) AS dimension13_name,
            (SELECT fdvt.description FROM fnd_dimension_value fdv LEFT JOIN fnd_dimension_value_tl fdvt ON fdv.DIMENSION_VALUE_ID = fdvt.DIMENSION_VALUE_ID AND fdvt.LANG = #{request.locale} where fdv.DIMENSION_VALUE_ID = h.dimension14_id) AS dimension14_name,
            (SELECT fdvt.description FROM fnd_dimension_value fdv LEFT JOIN fnd_dimension_value_tl fdvt ON fdv.DIMENSION_VALUE_ID = fdvt.DIMENSION_VALUE_ID AND fdvt.LANG = #{request.locale} where fdv.DIMENSION_VALUE_ID = h.dimension15_id) AS dimension15_name,
            (SELECT fdvt.description FROM fnd_dimension_value fdv LEFT JOIN fnd_dimension_value_tl fdvt ON fdv.DIMENSION_VALUE_ID = fdvt.DIMENSION_VALUE_ID AND fdvt.LANG = #{request.locale} where fdv.DIMENSION_VALUE_ID = h.dimension16_id) AS dimension16_name,
            (SELECT fdvt.description FROM fnd_dimension_value fdv LEFT JOIN fnd_dimension_value_tl fdvt ON fdv.DIMENSION_VALUE_ID = fdvt.DIMENSION_VALUE_ID AND fdvt.LANG = #{request.locale} where fdv.DIMENSION_VALUE_ID = h.dimension17_id) AS dimension17_name,
            (SELECT fdvt.description FROM fnd_dimension_value fdv LEFT JOIN fnd_dimension_value_tl fdvt ON fdv.DIMENSION_VALUE_ID = fdvt.DIMENSION_VALUE_ID AND fdvt.LANG = #{request.locale} where fdv.DIMENSION_VALUE_ID = h.dimension18_id) AS dimension18_name,
            (SELECT fdvt.description FROM fnd_dimension_value fdv LEFT JOIN fnd_dimension_value_tl fdvt ON fdv.DIMENSION_VALUE_ID = fdvt.DIMENSION_VALUE_ID AND fdvt.LANG = #{request.locale} where fdv.DIMENSION_VALUE_ID = h.dimension19_id) AS dimension19_name,
            (SELECT fdvt.description FROM fnd_dimension_value fdv LEFT JOIN fnd_dimension_value_tl fdvt ON fdv.DIMENSION_VALUE_ID = fdvt.DIMENSION_VALUE_ID AND fdvt.LANG = #{request.locale} where fdv.DIMENSION_VALUE_ID = h.dimension20_id) AS dimension20_name,
            h.description,
            (select t.relation_mode_code from exp_mo_report_type t where t.mo_exp_report_type_id = h.mo_exp_report_type_id) AS relation_method_code,
            (select t.req_required_flag from exp_mo_report_type t where t.mo_exp_report_type_id = h.mo_exp_report_type_id) AS req_required_flag,
            (case (select t.req_required_flag from exp_mo_report_type t where t.mo_exp_report_type_id = h.mo_exp_report_type_id) when 'Y' then 'True' else 'False' end) AS req_required,
            h.exp_requisition_header_id,
            (select eh.exp_requisition_number from exp_requisition_header eh where eh.exp_requisition_header_id = h.exp_requisition_header_id) AS exp_requisition_number,
            (SELECT gae.taxpayer_type FROM gld_accounting_entity gae WHERE gae.acc_entity_id = h.acc_entity_id) AS taxpayer_type,
            h.vat_invoice_flag,
            NULL AS doc_id,
            'EXP_REPORT' AS ref_doc_category,
            (select (case when sum(erl.payment_amount) is null then 0 else sum(erl.payment_amount) end) from exp_report_line erl where erl.exp_report_header_id = h.exp_report_header_id) AS rep_total_amount,
            h.doc_status,
             CASE
                            (SELECT DISTINCT
                                'Y'
                            FROM
                                exp_mo_rep_type_ref_ele e,
                                exp_report_page_element rv
                            WHERE
                                e.report_page_element_id = rv.report_page_element_id AND
                                rv.enabled_flag          = 'Y' AND
                                e.enabled_flag           = 'Y' AND
                                e.mo_exp_report_type_id  = h.mo_exp_report_type_id AND
                                (
                                    rv.report_page_element_code = 'TICKET_UNIFIED' OR
                                    rv.report_page_element_code = 'TRAVEL_STAY_UNIFIED'
                               )
                            )
            WHEN 'Y'
            THEN 'true'
            ELSE 'false'
            END AS monopolize_flag,
            (select srb.url
               from sys_resource_b srb
              where exists(select 1
                             from exp_req_page_element pe
                            where pe.readonly_service_id = srb.resource_id
                              and exists (select 1
                                            from exp_mo_req_type_ref_ele e
                                           where e.req_page_element_id = pe.req_page_element_id
                                             and e.mo_exp_req_type_id = (select erh.mo_exp_req_type_id from exp_requisition_header erh where erh.exp_requisition_header_id = h.exp_requisition_header_id)
                                             and e.enabled_flag = 'Y'
                                             and e.doc_type_code = 'HEADER')
                              and pe.enabled_flag = 'Y')) AS req_readonly_service_name,
            (select t.adjustment_flag from exp_mo_report_type t where t.mo_exp_report_type_id = h.mo_exp_report_type_id) AS adjustment_flag,
            (select emrt.auto_approve_flag from exp_mo_report_type emrt where emrt.mo_exp_report_type_id = h.mo_exp_report_type_id) AS auto_approve_flag
        FROM exp_report_header h
        WHERE h.exp_report_header_id = #{expReportHeaderId}
        union all
        SELECT
            NULL AS exp_report_header_id,
            #{moExpReportTypeId} AS mo_exp_report_type_id,
            (SELECT emrtt.description FROM exp_mo_report_type emrt LEFT JOIN exp_mo_report_type_tl emrtt ON emrt.MO_EXP_REPORT_TYPE_ID = emrtt.MO_EXP_REPORT_TYPE_ID AND emrtt.LANG = #{request.locale} WHERE emrt.MO_EXP_REPORT_TYPE_ID = #{moExpReportTypeId}) AS mo_exp_report_type_name,
            NULL AS exp_report_number,
            NULL AS amortization_flag,
            #{request.companyId} AS company_id,
            (SELECT fct.company_short_name FROM fnd_company fc LEFT JOIN fnd_company_tl fct ON fc.company_id = fct.company_id and fct.LANG = #{request.locale} where fc.COMPANY_ID = #{request.companyId}) AS company_name,
            #{accEntityId} AS acc_entity_id,
            (SELECT gaet.acc_entity_name FROM gld_accounting_entity gae LEFT JOIN gld_accounting_entity_tl gaet ON gae.ACC_ENTITY_ID = gaet.ACC_ENTITY_ID  AND gaet.LANG = #{request.locale} where gae.ACC_ENTITY_ID = #{accEntityId}) AS acc_entity_name,
            NULL AS resp_center_id,
            NULL AS resp_center_name,
            #{employeeId} AS employee_id,
            (select ee.name from exp_employee ee where ee.employee_id = #{employeeId}) AS employee_name,
            NULL AS position_id,
            NULL AS position_name,
            NULL AS unit_id,
            NULL AS unit_name,
            NULL AS bgt_entity_id,
            NULL AS bgt_entity_name,
            NULL AS bgt_center_id,
            NULL AS bgt_center_name,
            NULL AS report_date,
            NULL AS period_name,
            (select tv.payee_category from exp_mo_report_type tv where tv.mo_exp_report_type_id = #{moExpReportTypeId}) AS payee_category,
            NULL AS payee_category_name,
            NULL AS payee_id,
            NULL AS payee_name,
            NULL AS account_name,
            NULL AS account_number,
            NULL AS bank_name,
            NULL AS back_code,
            NULL AS bank_location_name,
            NULL AS bank_location_code,
            NULL AS province_name,
            NULL AS province_code,
            NULL AS city_name,
            NULL AS city_code,
            #{paymentCurrencyCode} AS payment_currency_code,
            (SELECT gct.currency_name FROM gld_currency gc LEFT JOIN gld_currency_tl gct ON gc.currency_id = gct.currency_id AND gct.lang = #{request.locale} WHERE gc.currency_code = #{paymentCurrencyCode}) AS payment_currency_name,
            (SELECT gc.finance_precision FROM gld_currency gc where gc.currency_code = #{paymentCurrencyCode}) AS payment_currency_precision,
            NULL AS pay2fun_exchange_type,
            NULL AS pay2fun_exchange_type_name,
            NULL AS pay2fun_exchange_rate,
            (select fc.managing_currency from fnd_company fc where fc.company_id = #{request.companyId}) AS management_currency_code,
            NULL AS management_currency_name,
            NULL AS management_currency_precision,
            NULL AS pay2mag_exchange_type,
            NULL AS pay2mag_exchange_type_name,
            NULL AS pay2mag_exchange_rate,
            NULL AS functional_currency_code,
            NULL AS functional_currency_name,
            NULL AS functional_currency_precision,
            NULL AS audit_flag,
            NULL AS audit_date,
            NULL AS audit_date_tz,
            NULL AS audit_date_ltz,
            (select rt.payment_method_id from exp_mo_report_type rt where rt.mo_exp_report_type_id = #{moExpReportTypeId}) AS payment_type_id,
            (SELECT cpmt.description FROM csh_payment_method cpm LEFT JOIN csh_payment_method_tl cpmt ON cpm.PAYMENT_METHOD_ID = cpmt.PAYMENT_METHOD_ID AND cpmt.LANG = #{request.locale} WHERE cpm.payment_method_id = (select payment_method_id from exp_mo_report_type rt where rt.mo_exp_report_type_id = #{moExpReportTypeId})) AS payment_type_name,
            (select ud.usedes_id from exp_mo_rep_type_ref_pay_ud ud where ud.mo_exp_report_type_id = #{moExpReportTypeId} and ud.default_flag = 'Y' and ud.enabled_flag = 'Y') AS payment_usede_id,
            (SELECT cmut.description FROM csh_mo_payment_used cmu LEFT JOIN csh_mo_payment_used_tl cmut ON cmu.payment_usede_id = cmut.payment_usede_id AND cmut.LANG = #{request.locale} WHERE cmu.payment_usede_id = (select ud.usedes_id from exp_mo_rep_type_ref_pay_ud ud where ud.mo_exp_report_type_id = #{moExpReportTypeId} and ud.default_flag = 'Y' and ud.enabled_flag = 'Y')) AS payment_usede_name,
            'GENERATE' AS report_status,
            (SELECT scv.meaning FROM sys_code_value_b scv LEFT JOIN sys_code_b sc ON scv.code_id = sc.code_id  WHERE scv.VALUE = 'GENERATE' AND sc.CODE = 'EXP_EXPENSE_REPORT_STATUS') AS report_status_name,
            (select ee.name from exp_employee ee left join sys_user su on su.employee_id = ee.employee_id where su.user_id = #{request.userId}) AS created_by_name,
            (select rt.payment_method_id from exp_mo_report_type rt where rt.mo_exp_report_type_id = #{moExpReportTypeId}) AS payment_method_id,
            (SELECT cpmt.description FROM csh_payment_method cpm LEFT JOIN csh_payment_method_tl cpmt ON cpm.PAYMENT_METHOD_ID = cpmt.PAYMENT_METHOD_ID AND cpmt.LANG = #{request.locale} WHERE cpm.payment_method_id = (select payment_method_id from exp_mo_report_type rt where rt.mo_exp_report_type_id = #{moExpReportTypeId})) AS payment_method_name,
            NULL AS dimension1_id,
            NULL AS dimension2_id,
            NULL AS dimension3_id,
            NULL AS dimension4_id,
            NULL AS dimension5_id,
            NULL AS dimension6_id,
            NULL AS dimension7_id,
            NULL AS dimension8_id,
            NULL AS dimension9_id,
            NULL AS dimension10_id,
            NULL AS dimension11_id,
            NULL AS dimension12_id,
            NULL AS dimension13_id,
            NULL AS dimension14_id,
            NULL AS dimension15_id,
            NULL AS dimension16_id,
            NULL AS dimension17_id,
            NULL AS dimension18_id,
            NULL AS dimension19_id,
            NULL AS dimension20_id,
            NULL AS dimension1_name,
            NULL AS dimension2_name,
            NULL AS dimension3_name,
            NULL AS dimension4_name,
            NULL AS dimension5_name,
            NULL AS dimension6_name,
            NULL AS dimension7_name,
            NULL AS dimension8_name,
            NULL AS dimension9_name,
            NULL AS dimension10_name,
            NULL AS dimension11_name,
            NULL AS dimension12_name,
            NULL AS dimension13_name,
            NULL AS dimension14_name,
            NULL AS dimension15_name,
            NULL AS dimension16_name,
            NULL AS dimension17_name,
            NULL AS dimension18_name,
            NULL AS dimension19_name,
            NULL AS dimension20_name,
            '' AS description,
            (select t.relation_mode_code from exp_mo_report_type t where t.mo_exp_report_type_id = #{moExpReportTypeId}) AS relation_method_code,
            (select t.req_required_flag from exp_mo_report_type t where t.mo_exp_report_type_id = #{moExpReportTypeId}) AS req_required_flag,
            (case (select t.req_required_flag from exp_mo_report_type t where t.mo_exp_report_type_id = #{moExpReportTypeId}) when 'Y' then 'True' else 'False' end) AS req_required,
            NULL AS exp_requisition_header_id,
            NULL AS exp_requisition_number,
            (SELECT gae.taxpayer_type FROM gld_accounting_entity gae WHERE gae.acc_entity_id = #{accEntityId}) AS taxpayer_type,
            'Y' AS vat_invoice_flag,
            NULL AS doc_id,
            'EXP_REPORT' AS ref_doc_category,
            0 AS rep_total_amount,
            '' AS doc_status,
             CASE
                            (SELECT DISTINCT
                                'Y'
                            FROM
                                exp_mo_rep_type_ref_ele e,
                                exp_report_page_element rv
                            WHERE
                                e.report_page_element_id = rv.report_page_element_id AND
                                rv.enabled_flag          = 'Y' AND
                                e.enabled_flag           = 'Y' AND
                                e.mo_exp_report_type_id  = #{moExpReportTypeId} AND
                                (
                                    rv.report_page_element_code = 'TICKET_UNIFIED' OR
                                    rv.report_page_element_code = 'TRAVEL_STAY_UNIFIED'
                               )
                            )
            WHEN 'Y'
            THEN 'true'
            ELSE 'false'
            END AS monopolize_flag,
            NULL AS req_readonly_service_name,
             (select t.adjustment_flag from exp_mo_report_type t where t.mo_exp_report_type_id = #{moExpReportTypeId}) AS adjustment_flag,
            (select emrt.auto_approve_flag from exp_mo_report_type emrt where emrt.mo_exp_report_type_id = #{moExpReportTypeId}) AS auto_approve_flag
        FROM dual
        WHERE #{expReportHeaderId} IS NULL

    </select>
    <select id="queryDistCount" resultType="long">
      select count(1)
      from exp_report_line l,
           exp_report_dist d
     where l.exp_report_header_id = #{expReportHeaderId}
           and d.exp_report_line_id = l.exp_report_line_id
    </select>


    <select id="getEmployeeByCompanyId" resultMap="com.hand.hap.exp.mapper.ExpEmployeeAssignMapper.BaseResultMap">
        select eea.employee_id,
        ee.employee_code,
        ee.name as employee_name,
        eea.position_id,
        (select eop.unit_id from exp_org_position eop where eop.position_id = eea.position_id) as unit_id,
        (select eopt.description from exp_org_position eop left join exp_org_position_tl eopt on eop.position_id = eopt.position_id and eopt.lang = #{request.locale} where eop.position_id = eea.position_id) as position_name,
        eea.acc_entity_id,
        (select gaet.acc_entity_name from gld_accounting_entity gae left join gld_accounting_entity_tl gaet on gae.acc_entity_id = gaet.acc_entity_id and gaet.lang = #{request.locale} where gae.acc_entity_id = eea.acc_entity_id) as acc_entity_name
        from exp_employee_assign eea left join exp_employee ee on eea.employee_id = ee.employee_id and ee.enabled_flag = 'Y'
        <where>
            eea.company_id = (case when #{companyId} is null then #{request.companyId} else #{companyId} end) and
            eea.enabled_flag = 'Y'
            <if test="positionId!=null">
                and eea.position_id = #{positionId}
            </if>
            <if test="primaryPositionFlag!=null">
                and eea.primary_position_flag = #{primaryPositionFlag}
            </if>
            <if test="employeeCode!=null">
                AND eea.employee_code like CONCAT('%',#{employeeCode},'%')
            </if>
            <if test="employeeName!=null">
                AND eea.employee_name like CONCAT('%',#{employeeName},'%')
            </if>
        </where>
    </select>
</mapper>