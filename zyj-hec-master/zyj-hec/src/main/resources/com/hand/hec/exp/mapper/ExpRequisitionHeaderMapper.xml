<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.hand.hec.exp.mapper.ExpRequisitionHeaderMapper">
    <resultMap id="BaseResultMap" type="com.hand.hec.exp.dto.ExpRequisitionHeader">
        <result column="PAYEE_CATEGORY" property="payeeCategory" jdbcType="VARCHAR"/>
        <result column="PAYEE_CATEGORY_NAME" property="payeeCategoryName" jdbcType="VARCHAR"/>
        <result column="PAYEE_ID" property="payeeId" jdbcType="DECIMAL"/>
        <result column="PAYEE_NAME" property="payeeName" jdbcType="VARCHAR"/>
        <result column="MO_EXP_REQ_TYPE_ID" property="moExpReqTypeId" jdbcType="DECIMAL"/>
        <result column="MO_EXP_REQ_TYPE_CODE" property="moExpReqTypeCode" jdbcType="VARCHAR"/>
        <result column="MO_EXP_REQ_TYPE_NAME" property="moExpReqTypeName" jdbcType="VARCHAR"/>
        <result column="MO_EMP_GROUP_ID" property="moEmpGroupId" jdbcType="DECIMAL"/>
        <result column="MO_EMP_GROUP_NAME" property="moEmpGroupName" jdbcType="VARCHAR"/>
        <result column="PAYMENT_CURRENCY_CODE" property="paymentCurrencyCode" jdbcType="VARCHAR"/>
        <result column="PAYMENT_CURRENCY_NAME" property="paymentCurrencyName" jdbcType="VARCHAR"/>
        <result column="PAY2FUN_EXCHANGE_TYPE" property="pay2funExchangeType" jdbcType="VARCHAR"/>
        <result column="PAY2FUN_EXCHANGE_TYPE_NAME" property="pay2funExchangeTypeName" jdbcType="VARCHAR"/>
        <result column="PAY2FUN_EXCHANGE_RATE" property="pay2funExchangeRate" jdbcType="DECIMAL"/>
        <result column="REQUISITION_DATE" property="requisitionDate" jdbcType="DATE"/>
        <result column="REQUISITION_DATE_TZ" property="requisitionDateTz" jdbcType="DATE"/>
        <result column="REQUISITION_DATE_LTZ" property="requisitionDateLtz" jdbcType="DATE"/>
        <result column="PERIOD_NAME" property="periodName" jdbcType="VARCHAR"/>
        <result column="REQUISITION_STATUS" property="requisitionStatus" jdbcType="VARCHAR"/>
        <result column="REQUISITION_STATUS_NAME" property="requisitionStatusName" jdbcType="VARCHAR"/>
        <result column="JE_CREATION_STATUS" property="jeCreationStatus" jdbcType="VARCHAR"/>
        <result column="AUDIT_FLAG" property="auditFlag" jdbcType="VARCHAR"/>
        <result column="GLD_INTERFACE_FLAG" property="gldInterfaceFlag" jdbcType="VARCHAR"/>
        <result column="ATTACHMENT_NUM" property="attachmentNum" jdbcType="DECIMAL"/>
        <result column="DESCRIPTION" property="description" jdbcType="VARCHAR"/>
        <result column="RELEASED_STATUS" property="releasedStatus" jdbcType="VARCHAR"/>
        <result column="REVERSED_FLAG" property="reversedFlag" jdbcType="VARCHAR"/>
        <result column="SOURCE_EXP_REQ_HEADER_ID" property="sourceExpReqHeaderId" jdbcType="DECIMAL"/>
        <result column="SOURCE_EXP_REQ_HEADER_NAME" property="sourceExpReqHeaderName" jdbcType="VARCHAR"/>
        <result column="SOURCE_TYPE" property="sourceType" jdbcType="VARCHAR"/>
        <result column="DIMENSION1_ID" property="dimension1Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION2_ID" property="dimension2Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION3_ID" property="dimension3Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION4_ID" property="dimension4Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION5_ID" property="dimension5Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION6_ID" property="dimension6Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION7_ID" property="dimension7Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION8_ID" property="dimension8Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION9_ID" property="dimension9Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION10_ID" property="dimension10Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION11_ID" property="dimension11Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION12_ID" property="dimension12Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION13_ID" property="dimension13Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION14_ID" property="dimension14Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION15_ID" property="dimension15Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION16_ID" property="dimension16Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION17_ID" property="dimension17Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION18_ID" property="dimension18Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION19_ID" property="dimension19Id" jdbcType="DECIMAL"/>
        <result column="DIMENSION20_ID" property="dimension20Id" jdbcType="DECIMAL"/>
        <result column="PAYMENT_FLAG" property="paymentFlag" jdbcType="VARCHAR"/>
        <result column="DEPARTURE_DATE" property="departureDate" jdbcType="DATE"/>
        <result column="ARRIVAL_DATE" property="arrivalDate" jdbcType="DATE"/>
        <result column="EXP_REQUISITION_HEADER_ID" property="expRequisitionHeaderId" jdbcType="DECIMAL"/>
        <result column="EXP_REQUISITION_NUMBER" property="expRequisitionNumber" jdbcType="VARCHAR"/>
        <result column="EXP_REQUISITION_BARCODE" property="expRequisitionBarcode" jdbcType="VARCHAR"/>
        <result column="COMPANY_ID" property="companyId" jdbcType="DECIMAL"/>
        <result column="COMPANY_NAME" property="companyName" jdbcType="VARCHAR"/>
        <result column="OPERATION_UNIT_ID" property="operationUnitId" jdbcType="DECIMAL"/>
        <result column="UNIT_ID" property="unitId" jdbcType="DECIMAL"/>
        <result column="UNIT_NAME" property="unitName" jdbcType="VARCHAR"/>
        <result column="POSITION_ID" property="positionId" jdbcType="DECIMAL"/>
        <result column="POSITION_NAME" property="positionName" jdbcType="VARCHAR"/>
        <result column="EMPLOYEE_ID" property="employeeId" jdbcType="DECIMAL"/>
        <result column="EMPLOYEE_NAME" property="employeeName" jdbcType="VARCHAR"/>
        <result column="ACC_ENTITY_ID" property="accEntityId" jdbcType="DECIMAL"/>
        <result column="ACC_ENTITY_NAME" property="accEntityName" jdbcType="VARCHAR"/>
        <result column="RESP_CENTER_ID" property="respCenterId" jdbcType="DECIMAL"/>
        <result column="RESP_CENTER_NAME" property="respCenterName" jdbcType="VARCHAR"/>
        <result column="BGT_ENTITY_ID" property="bgtEntityId" jdbcType="DECIMAL"/>
        <result column="BGT_ENTITY_NAME" property="bgtEntityName" jdbcType="VARCHAR"/>
        <result column="BGT_CENTER_ID" property="bgtCenterId" jdbcType="DECIMAL"/>
        <result column="BGT_CENTER_NAME" property="bgtCenterName" jdbcType="VARCHAR"/>

        <result column="REQUISITION_DATE_STR" property="requisitionDateStr" jdbcType="VARCHAR"/>
        <result column="TYPE_DESCRIPTION" property="typeDescription" jdbcType="VARCHAR"/>
        <result column="CLOSED_DATE" property="closedDate" jdbcType="VARCHAR"/>
        <result column="CURRENCY_NAME" property="currencyName" jdbcType="VARCHAR"/>
        <result column="QUARTER_NUM" property="quarterNum" jdbcType="DECIMAL"/>
        <result column="QUARTER_NUM_FUN" property="quarterNumFun" jdbcType="DECIMAL"/>
        <result column="REIMBURSED_NUM" property="reimbursedNum" jdbcType="DECIMAL"/>
        <result column="REIMBURSED_ADU_NUM" property="reimbursedAduNum" jdbcType="DECIMAL"/>
        <result column="REQUISITION_DATE_FROM" property="requisitionDateFrom" jdbcType="VARCHAR"/>
        <result column="REQUISITION_DATE_TO" property="requisitionDateTo" jdbcType="VARCHAR"/>
        <result column="CREATED_BY_NAME" property="createdByName" jdbcType="VARCHAR"/>
        <result column="REQ_TOTAL_AMOUNT" property="reqTotalAmount" jdbcType="DECIMAL"/>

        <result column="TOTAL_PAYMENT_AMOUNT" property="totalPaymentAmount" jdbcType="DECIMAL"/>
        <result column="PROGRESS_STATUS" property="progressStatus" jdbcType="VARCHAR"/>
        <result column="PROGRESS_STATUS_NAME" property="progressStatusName" jdbcType="VARCHAR"/>
        <result column="PROGRESS_COUNT" property="progressCount" jdbcType="DECIMAL"/>
        <result column="SERVICE_NAME" property="serviceName" jdbcType="VARCHAR"/>
        <result column="READONLY_SERVICE_NAME" property="readonlyServiceName" jdbcType="VARCHAR"/>
        <result column="INSTANCE_ID" property="instanceId" jdbcType="DECIMAL"/>
        <result column="REIMBURSED_AMOUNT" property="reimbursedAmount" jdbcType="DECIMAL"/>
        <result column="AUTO_APPROVE_FLAG" property="autoApproveFlag" jdbcType="VARCHAR"/>
        <result column="PAYMENT_CURRENCY_SYMBOL" property="paymentCurrencySymbol" jdbcType="VARCHAR"/>

    </resultMap>
    <select id="queryExpRequisitionMain" resultMap="BaseResultMap">
        SELECT
        erh.exp_requisition_header_id,
        erh.exp_requisition_number,
        erh.exp_requisition_barcode,
        erh.company_id,
        (
        SELECT
        fct.COMPANY_SHORT_NAME
        FROM
        fnd_company fc
        LEFT JOIN fnd_company_tl fct ON FC.COMPANY_ID = FCT.company_id
        AND fct.LANG = 'zh_CN'
        WHERE
        fc.COMPANY_ID = erh.company_id
        ) AS company_name,
        erh.operation_unit_id,
        erh.unit_id,
        (
        SELECT
        eout.DESCRIPTION
        FROM
        exp_org_unit eou
        LEFT JOIN exp_org_unit_tl eout ON eou.UNIT_ID = eout.UNIT_ID
        AND eout.LANG = 'zh_CN'
        WHERE
        eou.UNIT_ID = erh.unit_id
        ) AS unit_name,
        erh.position_id,
        (
        SELECT
        eopt.DESCRIPTION
        FROM
        exp_org_position eop
        LEFT JOIN exp_org_position_tl eopt ON eop.POSITION_ID = eopt.POSITION_ID
        AND eopt.LANG = 'zh_CN'
        WHERE
        eop.POSITION_ID = erh.position_id
        ) AS position_name,
        erh.employee_id,
        ( SELECT ee.`NAME` FROM exp_employee ee WHERE ee.EMPLOYEE_ID = erh.employee_id ) AS employee_name,
        erh.acc_entity_id,
        (
        SELECT
        gaet.ACC_ENTITY_NAME
        FROM
        gld_accounting_entity gae
        LEFT JOIN gld_accounting_entity_tl gaet ON gae.ACC_ENTITY_ID = gaet.ACC_ENTITY_ID
        AND gaet.LANG = 'zh_CN'
        WHERE
        gae.ACC_ENTITY_ID = erh.acc_entity_id
        ) AS acc_entity_name,
        erh.resp_center_id,
        (
        SELECT
        grct.RESPONSIBILITY_CENTER_NAME
        FROM
        gld_responsibility_center grc
        LEFT JOIN gld_responsibility_center_tl grct ON grc.RESPONSIBILITY_CENTER_ID = grct.RESPONSIBILITY_CENTER_ID
        AND grct.LANG = 'zh_CN'
        WHERE
        grc.RESPONSIBILITY_CENTER_ID = erh.resp_center_id
        ) AS resp_center_name,
        erh.bgt_entity_id,
        (
        SELECT
        bet.DESCRIPTION
        FROM
        bgt_entity be
        LEFT JOIN bgt_entity_tl bet ON be.ENTITY_ID = bet.ENTITY_ID
        AND bet.LANG = 'zh_CN'
        WHERE
        be.ENTITY_ID = erh.bgt_entity_id
        ) AS bgt_entity_name,
        erh.bgt_center_id,
        (
        SELECT
        bct.DESCRIPTION
        FROM
        bgt_center bc
        LEFT JOIN bgt_center_tl bct ON bc.CENTER_ID = bct.CENTER_ID
        AND bct.LANG = 'zh_CN'
        WHERE
        bc.CENTER_ID = erh.bgt_center_id
        ) AS bgt_center_name,
        erh.payee_category,
        (
        SELECT
        scvt.MEANING
        FROM
        sys_code_b scb
        INNER JOIN sys_code_value_b scvb ON scb.CODE_ID = scvb.CODE_ID
        INNER JOIN sys_code_value_tl scvt ON scvb.CODE_VALUE_ID = scvt.CODE_VALUE_ID
        AND scvt.LANG = 'zh_CN'
        AND scb.`CODE` = 'PAYMENT_OBJECT'
        WHERE
        scvb.`VALUE` = erh.payee_category
        ) AS payee_category_name,
        erh.payee_id,
        (
        CASE

        WHEN erh.payee_category = 'EMPLOYEE' THEN
        ( SELECT ees.`NAME` FROM exp_employee ees WHERE ees.employee_id = erh.payee_id )
        WHEN erh.payee_category = 'VENDER' THEN
        (
        SELECT
        psvt.DESCRIPTION
        FROM
        pur_system_vender psv
        LEFT JOIN pur_system_vender_tl psvt ON psv.VENDER_ID = psvt.VENDER_ID
        AND psvt.LANG = 'zh_CN'
        WHERE
        psv.VENDER_ID = erh.payee_id
        )
        WHEN erh.payee_category = 'CUSTOMER' THEN
        (
        SELECT
        osct.DESCRIPTION
        FROM
        ord_system_customer osc
        LEFT JOIN ord_system_customer_tl osct ON osc.CUSTOMER_ID = osct.CUSTOMER_ID
        AND osct.LANG = 'zh_CN'
        WHERE
        osc.CUSTOMER_ID = erh.payee_id
        ) ELSE ''
        END
        ) AS payee_name,
        erh.mo_exp_req_type_id,
        (
        SELECT
        emrt.MO_EXP_REQ_TYPE_CODE
        FROM
        exp_mo_req_type emrt
        LEFT JOIN exp_mo_req_type_tl emrtt ON emrt.MO_EXP_REQ_TYPE_ID = emrtt.MO_EXP_REQ_TYPE_ID
        AND emrtt.LANG = 'zh_CN'
        WHERE
        emrt.MO_EXP_REQ_TYPE_ID = erh.mo_exp_req_type_id
        ) mo_exp_req_type_code,
        (
        SELECT
        emrtt.DESCRIPTION
        FROM
        exp_mo_req_type emrt
        LEFT JOIN exp_mo_req_type_tl emrtt ON emrt.MO_EXP_REQ_TYPE_ID = emrtt.MO_EXP_REQ_TYPE_ID
        AND emrtt.LANG = 'zh_CN'
        WHERE
        emrt.MO_EXP_REQ_TYPE_ID = erh.mo_exp_req_type_id
        ) mo_exp_req_type_name,
        erh.mo_emp_group_id,
        (
        SELECT
        emegt.DESCRIPTION
        FROM
        exp_mo_emp_group emeg
        LEFT JOIN exp_mo_emp_group_tl emegt ON emeg.MO_EMP_GROUP_ID = emegt.MO_EMP_GROUP_ID
        AND emegt.LANG = 'zh_CN'
        WHERE
        emeg.MO_EMP_GROUP_ID = erh.mo_emp_group_id
        ) mo_emp_group_name,
        erh.payment_currency_code,
        (
        SELECT
        gct.CURRENCY_NAME
        FROM
        gld_currency gc
        LEFT JOIN gld_currency_tl gct ON gc.CURRENCY_ID = gct.CURRENCY_ID
        AND gct.LANG = 'zh_CN'
        WHERE
        gc.COUNTRY_CODE = erh.payment_currency_code
        ) AS payment_currency_name,
        (
        SELECT
        gc.CURRENCY_SYMBOL
        FROM
        gld_currency gc
        LEFT JOIN gld_currency_tl gct ON gc.CURRENCY_ID = gct.CURRENCY_ID
        AND gct.LANG = 'zh_CN'
        WHERE
        gc.COUNTRY_CODE = erh.payment_currency_code
        ) AS payment_currency_symbol,
        erh.pay2fun_exchange_type,
        (
        SELECT
        gett.DESCRIPTION
        FROM
        gld_exchangerate_type ge
        LEFT JOIN gld_exchangerate_type_tl gett ON ge.TYPE_ID = gett.TYPE_ID
        AND gett.LANG = 'zh_CN'
        WHERE
        ge.TYPE_CODE = erh.pay2fun_exchange_type
        ) AS pay2fun_exchange_type_name,
        erh.pay2fun_exchange_rate,
        date_format( erh.requisition_date, '%Y-%m-%d' ) requisition_date,
        erh.requisition_date_tz,
        erh.requisition_date_ltz,
        erh.period_name,
        erh.requisition_status,
        (
        SELECT
        scvt.MEANING
        FROM
        sys_code_b scb
        INNER JOIN sys_code_value_b scvb ON scb.CODE_ID = scvb.CODE_ID
        INNER JOIN sys_code_value_tl scvt ON scvb.CODE_VALUE_ID = scvt.CODE_VALUE_ID
        AND scvt.LANG = 'zh_CN'
        AND scb.`CODE` = 'EXP_EXPENSE_REPORT_STATUS'
        WHERE
        scvb.`VALUE` = erh.requisition_status
        ) requisition_status_name,
        erh.je_creation_status,
        erh.audit_flag,
        erh.gld_interface_flag,
        erh.attachment_num,
        erh.description,
        erh.released_status,
        erh.reversed_flag,
        erh.source_exp_req_header_id,
        erh.source_type,
        erh.dimension1_id,
        erh.dimension2_id,
        erh.dimension3_id,
        erh.dimension4_id,
        erh.dimension5_id,
        erh.dimension6_id,
        erh.dimension7_id,
        erh.dimension8_id,
        erh.dimension9_id,
        erh.dimension10_id,
        erh.dimension11_id,
        erh.dimension12_id,
        erh.dimension13_id,
        erh.dimension14_id,
        erh.dimension15_id,
        erh.dimension16_id,
        erh.dimension17_id,
        erh.dimension18_id,
        erh.dimension19_id,
        erh.dimension20_id,
        '' AS dimension1_name,
        '' AS dimension2_name,
        '' AS dimension3_name,
        '' AS dimension4_name,
        '' AS dimension5_name,
        '' AS dimension6_name,
        '' AS dimension7_name,
        '' AS dimension8_name,
        '' AS dimension9_name,
        '' AS dimension10_name,
        '' AS dimension11_name,
        '' AS dimension12_name,
        '' AS dimension13_name,
        '' AS dimension14_name,
        '' AS dimension15_name,
        '' AS dimension16_name,
        '' AS dimension17_name,
        '' AS dimension18_name,
        '' AS dimension19_name,
        '' AS dimension20_name,
        ( SELECT ifnull ( sum( erl.PAYMENT_AMOUNT ), 0 ) FROM exp_requisition_line erl WHERE
        erl.EXP_REQUISITION_HEADER_ID = erh.EXP_REQUISITION_HEADER_ID ) total_payment_amount,
        'GENERATE' AS progress_status,
        '' AS progress_status_name,
        '' AS progress_count,
        (
        SELECT
        ee.`NAME`
        FROM
        sys_user su
        LEFT JOIN exp_employee ee ON su.EMPLOYEE_ID = ee.EMPLOYEE_ID
        WHERE
        su.USER_ID = erh.CREATED_BY
        ) AS created_by_name,
        '' service_name,
        '' readonly_service_name,
        '' instance_id,
        0 AS reimbursed_amount,
        '' auto_approve_flag
        FROM
        exp_requisition_header erh
        <where>
            <include refid="queryCondition"/>
        </where>
        ORDER BY exp_requisition_number DESC
    </select>
    <sql id="queryCondition">
            erh.company_id = 10791 and
            erh.created_by = 2801
    </sql>
    <select id="queryByPayReqHeaderId" resultType="java.util.Map">
      SELECT
            h.exp_requisition_header_id expRequisitionHeaderId,
            h.exp_requisition_number expRequisitionNumber,
            h.requisition_date AS requisitionDate,
            h.payment_currency_code AS currencyCode,
            ( SELECT SUM( l.payment_amount ) from exp_requisition_line l WHERE l.exp_requisition_header_id = h.exp_requisition_header_id ) AS requisitionAmount,
            ( SELECT SUM( l.requisition_functional_amount ) FROM exp_requisition_line l WHERE l.exp_requisition_header_id = h.exp_requisition_header_id ) AS functionalRequisitionAmount,
            h.employee_id employeeId,
            ( SELECT ee.NAME FROM exp_employee ee WHERE ee.employee_id = h.employee_id ) AS employeeName,
            h.requisition_status requisitionStatus,
            (
            SELECT
                cvt.meaning
            FROM
                sys_code_b cb
                LEFT JOIN sys_code_value_b cvb ON cb.code_id = cvb.code_id
                LEFT JOIN sys_code_value_tl cvt ON cvb.code_value_id = cvt.code_value_id
            WHERE
                cb.CODE = 'EXP_EXPENSE_REPORT_STATUS'
                AND cvb.VALUE = h.requisition_status
                AND cvt.lang = #{request.locale}
            ) requisitionStatusName,
            #{closeStatus} AS closeStatus,
            (
            SELECT
                cvt.meaning
            FROM
                sys_code_b cb
                LEFT JOIN sys_code_value_b cvb ON cb.code_id = cvb.code_id
                LEFT JOIN sys_code_value_tl cvt ON cvb.code_value_id = cvt.code_value_id
            WHERE
                cb.CODE = 'EXP_REQUISITION_CLOSE_STATUS'
                AND cvb.VALUE = #{closeStatus}
                AND cvt.lang = #{request.locale}
            ) AS closeStatusName,
            h.creation_date AS creationDate,
            h.description,
            (
            SELECT
                gct.currency_name
            FROM
                gld_currency gc
                LEFT JOIN gld_currency_tl gct ON gc.CURRENCY_ID = gct.CURRENCY_ID
            WHERE
                gc.currency_code = h.payment_currency_code
            ) currencyName
        FROM
            exp_requisition_header h,
            csh_payment_requisition_ln cprl
        WHERE
            h.exp_requisition_header_id = cprl.ref_document_id
            AND cprl.payment_requisition_line_type = 'EXP_REQUISITION'
            AND cprl.payment_requisition_header_id = #{headerId}
        ORDER BY
            h.exp_requisition_number DESC
    </select>

    <select id="queryPartCloseFlag" resultType="java.lang.String">
      select 'Y'
        from dual
       where exists
       (select 1
                from exp_requisition_dist erd,
                     exp_requisition_line erl
               where erd.exp_requisition_line_id = erl.exp_requisition_line_id
                     and erl.exp_requisition_header_id =
                     #{headerId}
                     and erd.close_flag = 'Y')
    </select>

    <select id="queryComCloseFlag" resultType="java.lang.String">
      select 'Y'
        from dual
       where exists
       (select 1
                from exp_requisition_dist erd,
                     exp_requisition_line erl
               where erd.exp_requisition_line_id = erl.exp_requisition_line_id
                     and erl.exp_requisition_header_id =
                     #{headerId}
                     and erd.close_flag = 'N')
    </select>

    <select id="queryExp5360" parameterType="com.hand.hec.exp.dto.ExpRequisitionHeader" resultMap="BaseResultMap">
        SELECT
        s.exp_requisition_header_id,
        s.exp_requisition_number,
        s.exp_requisition_barcode,
        s.company_id,
        s.reversed_flag,
        s.audit_flag,
        s.period_name,
        s.released_status,
        s.je_creation_status,
        s.gld_interface_flag,
        s.created_by,
        s.creation_date,
        s.last_updated_by,
        s.last_update_date,
        s.employee_id,
        date_format(
        s.requisition_date,
        '%Y-%m-%d'
        ) requisition_date_str,
        (
        SELECT
        erpv.description
        FROM
        exp_mo_req_type erpv
        WHERE
        erpv.mo_exp_req_type_id = s.mo_exp_req_type_id
        ) type_description,
        date_format(now(), '%Y-%m-%d') closed_date,
        (
        SELECT
        currency_name
        FROM
        gld_currency gcv
        WHERE
        gcv.currency_code = s.payment_currency_code
        ) currency_name,
        (
        SELECT
        SUM(T.payment_amount)
        FROM
        exp_requisition_line T
        WHERE
        T.exp_requisition_header_id = s.exp_requisition_header_id
        ) quarter_num,
        (
        SELECT
        SUM(
        T.requisition_functional_amount
        )
        FROM
        exp_requisition_line T
        WHERE
        T.exp_requisition_header_id = s.exp_requisition_header_id
        ) quarter_num_fun,
        (
        SELECT
        IFNULL(sum(req_release_amount), 0)
        FROM
        exp_requisition_release r,
        exp_report_header H
        WHERE
        r.document_type = 'EXP_REPORT'
        AND r.document_id = H.exp_report_header_id
        AND r.exp_requisition_header_id = s.exp_requisition_header_id
        ) reimbursed_num,
        (
        SELECT
        ifnull(
        sum(r.req_release_amount),
        0
        )
        FROM
        exp_requisition_release r,
        exp_report_header H
        WHERE
        r.document_type = 'EXP_REPORT'
        AND r.document_id = H.exp_report_header_id
        AND r.exp_requisition_header_id = s.exp_requisition_header_id
        AND H.audit_flag = 'Y'
        ) reimbursed_adu_num,
        (
        SELECT
        NAME
        FROM
        exp_employee es
        WHERE
        es.employee_id = s.employee_id
        ) employee_name,
        s.description
        FROM
        exp_requisition_header s
        where 1=1
        <if test="expRequisitionHeader.expRequisitionNumber != null">
            AND s.exp_requisition_number like &apos;%${expRequisitionHeader.expRequisitionNumber}%&apos;
        </if>

        <if test="expRequisitionHeader.moExpReqTypeId != null">
            AND s.mo_exp_req_type_id=#{expRequisitionHeader.moExpReqTypeId}
        </if>

        <if test="expRequisitionHeader.requisitionDateFrom != null">
            AND s.requisition_date &gt;= str_to_date(#{expRequisitionHeader.requisitionDateFrom},&apos;%Y-%m-%d%H&apos;)
        </if>

        <if test="expRequisitionHeader.requisitionDateTo != null">
            AND s.requisition_date &lt;= str_to_date(#{expRequisitionHeader.requisitionDateTo},&apos;%Y-%m-%d%H&apos;)
        </if>

    </select>

    <select id="queryDetailHead" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT
	erh.exp_requisition_number,
	(
		SELECT
			erpv.description
		FROM
			exp_mo_req_type erpv
		WHERE
			erpv.mo_exp_req_type_id = erh.mo_exp_req_type_id
	) type_description,
	(
		SELECT
			NAME
		FROM
			exp_employee es
		WHERE
			es.employee_id = erh.employee_id
	) employee_name,
	date_format(
		erh.requisition_date,
		'%Y-%m-%d'
	) requisition_date_str,
	(
		SELECT
			description
		FROM
			exp_org_unit
		WHERE
			unit_id = erh.unit_id
	) AS unit_name,
	(
		SELECT
			ACC_ENTITY_NAME
		FROM
			gld_accounting_entity
		WHERE
			acc_entity_id = erh.acc_entity_id
	) acc_entity_name,
	erh.attachment_num,
	erh.requisition_status,
	(
		SELECT
			NAME
		FROM
			exp_employee es
		WHERE
			es.employee_id = erh.created_by
	) created_by_name,
	 (select ifnull(sum(erl.payment_amount),
               0)
      from exp_requisition_line erl where erl.exp_requisition_header_id=erh.exp_requisition_header_id)req_total_amount,
	ifnull(erh.payment_flag,'N') payment_flag,
	erh.description
FROM
	exp_requisition_header erh where erh.exp_requisition_header_id=#{headId}
    </select>

    <update id="closeDetailHead">

    </update>

    <select id="getReleaseAmount" parameterType="java.lang.Long" resultType="java.math.BigDecimal">
        select ifnull(sum(bbr.amount),0)
         from bgt_budget_reserve bbr
         where bbr.document_line_id = #{distId}
    </select>

    <select id="getReleaseQuantity" parameterType="java.lang.Long" resultType="java.math.BigDecimal">
        select ifnull(sum(bbr.quantity),0)
         from bgt_budget_reserve bbr
         where bbr.document_line_id = #{distId}
    </select>

    <select id="getHeardIdByDistId" parameterType="java.lang.Long" resultType="java.lang.Long">
        select erh.exp_requisition_header_id
        from exp_requisition_dist   erd,
              exp_requisition_line   erl,
              exp_requisition_header erh
       where
             erd.exp_requisition_dist_id = #{distId}
             and
             erd.exp_requisition_line_id = erl.exp_requisition_line_id
             and
             erl.exp_requisition_header_id = erh.exp_requisition_header_id
    </select>

    <select id="getOneOffFlagByDistId" parameterType="java.lang.Long" resultType="java.lang.String">
        select
             emrt.one_off_flag
        from exp_requisition_dist   erd,
             exp_mo_req_type        emrt
       where
             erd.exp_requisition_dist_id = #{distId}
             and erh.mo_exp_req_type_id = emrt.mo_exp_req_type_id
    </select>

    <select id="getbgtOrgId" parameterType="java.lang.Long" resultType="java.lang.Long">
        SELECT
	    e.bgt_org_id
        FROM
	    bgt_entity e
        WHERE
	    e.entity_id = #{bgtEntityId}
    </select>
    <select id="expRequisitionHeaderQuery" resultMap="BaseResultMap">
     select v.EXP_REQUISITION_HEADER_ID,
            v.EXP_REQUISITION_NUMBER,
            v.COMPANY_ID,
            v.company_name,
            v.POSITION_ID,
            v.POSITION_NAME,
            v.UNIT_ID,
            v.UNIT_NAME,
            v.EMPLOYEE_ID,
            v.employee_name,
            v.ACC_ENTITY_ID,
            v.acc_entity_name,
            v.payee_category,
            v.payee_category_name,
            v.PAYEE_ID,
            v.MO_EXP_REQ_TYPE_ID,
            v.mo_exp_req_type_name,
            v.MO_EMP_GROUP_ID,
            v.mo_emp_group_name,
            v.PAYMENT_CURRENCY_CODE,
            v.payment_currency_name,
            v.payment_curreny_precision,
            v.PAY2FUN_EXCHANGE_TYPE,
            v.pay2fun_exchange_type_name,
            v.PAY2FUN_EXCHANGE_RATE,
            v.management_currency_code,
            v.management_currency_name,
            v.management_currency_precision,
            v.pay2mag_exchange_type,
            v.pay2mag_exchange_type_name,
            v.pay2mag_exchange_rate,
            v.functional_currency_code,
            v.requisition_date,
            v.requisition_date_tz,
            v.requisition_date_ltz,
            v.period_name,
            v.requisition_status,
            v.requisition_status_name,
            v.je_creation_status,
            v.audit_flag,
            v.gld_interface_flag,
            v.attachment_num,
            v.description,
            v.released_status,
            v.reversed_flag,
            v.source_exp_req_header_id,
            v.source_type,
            v.created_by_name,
            v.payment_flag,
            v.DIMENSION1_ID,
            v.DIMENSION2_ID,
            v.DIMENSION3_ID,
            v.DIMENSION4_ID,
            v.DIMENSION5_ID,
            v.DIMENSION6_ID,
            v.DIMENSION7_ID,
            v.DIMENSION8_ID,
            v.DIMENSION9_ID,
            v.DIMENSION10_ID,
            v.DIMENSION11_ID,
            v.DIMENSION12_ID,
            v.DIMENSION13_ID,
            v.DIMENSION14_ID,
            v.DIMENSION15_ID,
            v.DIMENSION16_ID,
            v.DIMENSION17_ID,
            v.DIMENSION18_ID,
            v.DIMENSION19_ID,
            v.DIMENSION20_ID,
            v.departure_date,
            v.arrival_date,
            v.auto_approve_flag
       from  (
       SELECT
	erh.EXP_REQUISITION_HEADER_ID,
	erh.EXP_REQUISITION_NUMBER,
	erh.COMPANY_ID,
	(
SELECT
	fct.company_short_name
FROM
	fnd_company fc
	LEFT JOIN fnd_company_tl fct ON fc.company_id = fct.company_id
	AND fct.LANG = #{request.locale}

WHERE
	fc.COMPANY_ID = erh.COMPANY_ID
	) AS company_name,
	erh.POSITION_ID,
	(select eopt.DESCRIPTION
	from exp_org_position eop left join exp_org_position_tl eopt
	on eopt.POSITION_ID=eop.POSITION_ID and eopt.LANG=#{request.locale}
	where eop.POSITION_ID=erh.POSITION_ID
	)POSITION_NAME,
	erh.UNIT_ID,
	(select eout.DESCRIPTION
	from exp_org_unit eou left join exp_org_unit_tl eout
	on eou.UNIT_ID=eout.UNIT_ID and eout.LANG=#{request.locale}
	where eou.UNIT_ID=erh.UNIT_ID)UNIT_NAME,
	erh.EMPLOYEE_ID,
	(SELECT ee.`NAME`
	    FROM  exp_employee ee
	    WHERE ee.EMPLOYEE_ID = erh.EMPLOYEE_ID)employee_name,
	erh.ACC_ENTITY_ID,
	(SELECT gaet.ACC_ENTITY_NAME
		FROM  gld_accounting_entity_tl gaet
		WHERE gaet.ACC_ENTITY_ID = erh.ACC_ENTITY_ID
        AND gaet.LANG = #{request.locale})acc_entity_name,
		erh.payee_category,
    (SELECT scv.meaning
		 FROM  sys_code_value_b scv
		 LEFT JOIN sys_code_b sc
		 ON scv.code_id = sc.code_id
		 WHERE scv.VALUE= erh.payee_category
		 AND sc.CODE = 'PAYMENT_OBJECT') payee_category_name,
		erh.PAYEE_ID,
	  erh.MO_EXP_REQ_TYPE_ID,
	  (select emrtt.DESCRIPTION
		from exp_mo_req_type emrt left join exp_mo_req_type_tl emrtt on emrt.MO_EXP_REQ_TYPE_ID=emrtt.MO_EXP_REQ_TYPE_ID and emrtt.LANG=#{request.locale}
		where emrt.MO_EXP_REQ_TYPE_ID=erh.MO_EXP_REQ_TYPE_ID)	mo_exp_req_type_name,
		erh.MO_EMP_GROUP_ID,
		(select egt.DESCRIPTION
		from exp_mo_emp_group_tl egt
		where egt.LANG=#{request.locale}
		and egt.MO_EMP_GROUP_ID=erh.MO_EMP_GROUP_ID)mo_emp_group_name,
		erh.PAYMENT_CURRENCY_CODE,
		(SELECT  gct.currency_name
		 FROM   gld_currency gc
		 LEFT JOIN gld_currency_tl gct
		 ON gc.currency_id = gct.currency_id
		 AND gct.lang = #{request.locale}
		 WHERE gc.currency_code = erh.PAYMENT_CURRENCY_CODE)payment_currency_name,
		 (SELECT gc.FINANCE_PRECISION
		 FROM gld_currency gc
		 WHERE gc.CURRENCY_CODE = erh.PAYMENT_CURRENCY_CODE) payment_curreny_precision,
		 erh.PAY2FUN_EXCHANGE_TYPE,
		 (select ett.DESCRIPTION
		 from gld_exchangerate_type et left join gld_exchangerate_type_tl ett on
		 et.TYPE_ID=ett.TYPE_ID and ett.LANG=#{request.locale}
		 where et.TYPE_CODE=erh.PAY2FUN_EXCHANGE_TYPE)pay2fun_exchange_type_name,
		 erh.PAY2FUN_EXCHANGE_RATE,
		 		(SELECT fc.MANAGING_CURRENCY
		 FROM fnd_company fc
		 WHERE fc.company_id = erh.company_id)management_currency_code,
		(SELECT gct.CURRENCY_NAME
		  FROM fnd_company fc,
			   gld_currency gc
		  LEFT JOIN gld_currency_tl gct
		  ON gc.CURRENCY_ID = gct.CURRENCY_ID
		  AND gct.LANG = #{request.locale}
			where fc.COMPANY_ID=erh.company_id
			and fc.MANAGING_CURRENCY=gc.COUNTRY_CODE)management_currency_name,
		  (SELECT gc.FINANCE_PRECISION
		  FROM fnd_company fc,
		       gld_currency gc
		  WHERE fc.company_id = erh.COMPANY_ID
		  AND fc.MANAGING_CURRENCY = gc.COUNTRY_CODE) management_currency_precision,
			NULL AS pay2mag_exchange_type,
		  NULL AS pay2mag_exchange_type_name,
		  NULL AS pay2mag_exchange_rate,
			(SELECT IFNULL( gae.FUNCTIONAL_CURRENCY_CODE, gsob.FUNCTIONAL_CURRENCY_CODE )
			FROM gld_accounting_entity gae,
				  gld_set_of_book gsob
			WHERE gae.ACC_ENTITY_ID = erh.ACC_ENTITY_ID
            AND gsob.SET_OF_BOOKS_ID = gae.DEFAULT_SET_OF_BOOKS_ID) functional_currency_code,
						date_format( erh.REQUISITION_DATE, '%Y-%m-%d' ) requisition_date,
						erh.requisition_date_tz,
            erh.requisition_date_ltz,
            erh.period_name,
            erh.requisition_status,
						(SELECT scv.meaning
			FROM sys_code_value_b scv
			LEFT JOIN sys_code_b sc
			ON scv.code_id = sc.code_id
			WHERE scv.VALUE= erh.requisition_status
			AND sc.CODE = 'EXP_EXPENSE_REPORT_STATUS') requisition_status_name,
			erh.je_creation_status,
                    erh.audit_flag,
                    erh.gld_interface_flag,
                    erh.attachment_num,
                    erh.description,
                    erh.released_status,
                    erh.reversed_flag,
                    erh.source_exp_req_header_id,
                    erh.source_type,
										( SELECT ee.`NAME`
			FROM sys_user su,
			     exp_employee ee
			WHERE su.USER_ID = erh.CREATED_BY
			  AND su.EMPLOYEE_ID = ee.EMPLOYEE_ID) created_by_name,
			'N' payment_flag,
			erh.DIMENSION1_ID,
			erh.DIMENSION2_ID,
			erh.DIMENSION3_ID,
			erh.DIMENSION4_ID,
			erh.DIMENSION5_ID,
			erh.DIMENSION6_ID,
			erh.DIMENSION7_ID,
			erh.DIMENSION8_ID,
			erh.DIMENSION9_ID,
			erh.DIMENSION10_ID,
			erh.DIMENSION11_ID,
			erh.DIMENSION12_ID,
			erh.DIMENSION13_ID,
			erh.DIMENSION14_ID,
			erh.DIMENSION15_ID,
			erh.DIMENSION16_ID,
			erh.DIMENSION17_ID,
			erh.DIMENSION18_ID,
			erh.DIMENSION19_ID,
			erh.DIMENSION20_ID,
			date_format( erh.DEPARTURE_DATE, '%Y-%m-%d' ) departure_date,
      date_format( erh.ARRIVAL_DATE, '%Y-%m-%d' ) arrival_date,
		 (select emrt.AUTO_APPROVE_FLAG
		 from exp_mo_req_type emrt
		 where emrt.MO_EXP_REQ_TYPE_ID=erh.MO_EXP_REQ_TYPE_ID)auto_approve_flag
FROM
	exp_requisition_header erh
WHERE
	erh.exp_requisition_header_id = #{expRequisitionHeaderId})v
    </select>
    <select id="expReqHeaderCreateQuery" resultMap="BaseResultMap">
     select v.EXP_REQUISITION_HEADER_ID,
            v.EXP_REQUISITION_NUMBER,
            v.COMPANY_ID,
            v.company_name,
            v.POSITION_ID,
            v.POSITION_NAME,
            v.UNIT_ID,
            v.UNIT_NAME,
            v.EMPLOYEE_ID,
            v.employee_name,
            v.ACC_ENTITY_ID,
            v.acc_entity_name,
            v.payee_category,
            v.payee_category_name,
            v.PAYEE_ID,
            v.MO_EXP_REQ_TYPE_ID,
            v.mo_exp_req_type_name,
            v.MO_EMP_GROUP_ID,
            v.mo_emp_group_name,
            v.PAYMENT_CURRENCY_CODE,
            v.payment_currency_name,
            v.payment_curreny_precision,
            v.PAY2FUN_EXCHANGE_TYPE,
            v.pay2fun_exchange_type_name,
            v.PAY2FUN_EXCHANGE_RATE,
            v.management_currency_code,
            v.management_currency_name,
            v.management_currency_precision,
            v.pay2mag_exchange_type,
            v.pay2mag_exchange_type_name,
            v.pay2mag_exchange_rate,
            v.functional_currency_code,
            v.requisition_date,
            v.requisition_date_tz,
            v.requisition_date_ltz,
            v.period_name,
            v.requisition_status,
            v.requisition_status_name,
            v.je_creation_status,
            v.audit_flag,
            v.gld_interface_flag,
            v.attachment_num,
            v.description,
            v.released_status,
            v.reversed_flag,
            v.source_exp_req_header_id,
            v.source_type,
            v.created_by_name,
            v.payment_flag,
            v.DIMENSION1_ID,
            v.DIMENSION2_ID,
            v.DIMENSION3_ID,
            v.DIMENSION4_ID,
            v.DIMENSION5_ID,
            v.DIMENSION6_ID,
            v.DIMENSION7_ID,
            v.DIMENSION8_ID,
            v.DIMENSION9_ID,
            v.DIMENSION10_ID,
            v.DIMENSION11_ID,
            v.DIMENSION12_ID,
            v.DIMENSION13_ID,
            v.DIMENSION14_ID,
            v.DIMENSION15_ID,
            v.DIMENSION16_ID,
            v.DIMENSION17_ID,
            v.DIMENSION18_ID,
            v.DIMENSION19_ID,
            v.DIMENSION20_ID,
            v.departure_date,
            v.arrival_date,
            v.auto_approve_flag
       from  (
       SELECT
        NULL AS exp_requisition_header_id,
	    NULL AS exp_requisition_number,
        #{request.companyId} AS company_id,
	    (SELECT fct.company_short_name
         FROM  fnd_company fc
	     LEFT JOIN fnd_company_tl fct
	     ON fc.company_id = fct.company_id
	     AND fct.LANG = #{request.locale}
	     where fc.COMPANY_ID = #{request.companyId}) AS company_name,
	    (SELECT A.POSITION_ID
        FROM exp_employee_assign a
        WHERE a.employee_id = #{employeeId}
	    AND a.company_id = #{request.companyId}
	    AND a.primary_position_flag = 'Y'
	    AND a.enabled_flag = 'Y') POSITION_ID,
	   (SELECT  eopt.DESCRIPTION
	    FROM  exp_employee_assign a
		LEFT JOIN exp_org_position_tl eopt
		ON a.POSITION_ID = eopt.POSITION_ID
		AND eopt.LANG = #{request.locale}
	    WHERE a.employee_id = #{employeeId}
		AND a.company_id = #{request.companyId}
		AND a.primary_position_flag = 'Y'
		AND a.enabled_flag = 'Y') POSITION_NAME,
	   (SELECT eop.UNIT_ID
	    FROM
		exp_employee_assign a,
		exp_org_position eop
	    WHERE a.employee_id = #{employeeId}
		AND a.company_id = #{request.companyId}
		AND a.primary_position_flag = 'Y'
		AND a.enabled_flag = 'Y'
		AND eop.POSITION_ID = a.POSITION_ID) UNIT_ID,
	   (SELECT eout.DESCRIPTION
	    FROM
		exp_employee_assign a,
		exp_org_position eop
		LEFT JOIN exp_org_unit_tl eout
		ON eop.UNIT_ID = eout.UNIT_ID
		AND eout.LANG = #{request.locale}
		WHERE a.employee_id = #{employeeId}
		AND a.company_id = #{request.companyId}
		AND a.primary_position_flag = 'Y'
		AND a.enabled_flag = 'Y'
		AND eop.POSITION_ID = a.POSITION_ID) UNIT_NAME,
        #{employeeId} employee_id,
	   (SELECT ee.`NAME`
	    FROM  exp_employee ee
	    WHERE ee.EMPLOYEE_ID = #{employeeId})employee_name,
        #{accEntityId} acc_entity_id,
		(SELECT gaet.ACC_ENTITY_NAME
		FROM  gld_accounting_entity_tl gaet
		WHERE gaet.ACC_ENTITY_ID = #{accEntityId}
        AND gaet.LANG = #{request.locale})acc_entity_name,
	    emrt.payee_category,
		(SELECT scv.meaning
		 FROM  sys_code_value_b scv
		 LEFT JOIN sys_code_b sc
		 ON scv.code_id = sc.code_id
		 WHERE scv.VALUE= emrt.payee_category
		 AND sc.CODE = 'PAYMENT_OBJECT') payee_category_name,
		CASE emrt.payee_category
		WHEN 'EMPLOYEE' THEN
        #{employeeId}
		ELSE
		    NULL
		END AS payee_id,
		emrt.mo_exp_req_type_id,
		emrtt.DESCRIPTION mo_exp_req_type_name,
		NULL AS mo_emp_group_id,
		NULL AS mo_emp_group_name,
        #{paymentCurrencyCode} AS payment_currency_code,
		(SELECT  gct.currency_name
		 FROM   gld_currency gc
		 LEFT JOIN gld_currency_tl gct
		 ON gc.currency_id = gct.currency_id
		 AND gct.lang = #{request.locale}
		 WHERE gc.currency_code = #{paymentCurrencyCode})payment_currency_name,
		(SELECT gc.FINANCE_PRECISION
		 FROM gld_currency gc
		 WHERE gc.CURRENCY_CODE = #{paymentCurrencyCode}) payment_curreny_precision,
		 NULL AS pay2fun_exchange_type,
		 NULL AS pay2fun_exchange_type_name,
		 NULL AS pay2fun_exchange_rate,
		(SELECT fc.MANAGING_CURRENCY
		 FROM fnd_company fc
		 WHERE fc.company_id = #{request.companyId})management_currency_code,
		(SELECT gct.CURRENCY_NAME
		  FROM fnd_company fc,
			   gld_currency gc
		  LEFT JOIN gld_currency_tl gct
		  ON gc.CURRENCY_ID = gct.CURRENCY_ID
		  AND gct.LANG = #{request.locale}
		  where fc.company_id = #{request.companyId}
		  and fc.MANAGING_CURRENCY=gc.COUNTRY_CODE)management_currency_name,
		  (SELECT gc.FINANCE_PRECISION
		  FROM fnd_company fc,
		       gld_currency gc
		  WHERE fc.company_id = #{request.companyId}
		  AND fc.MANAGING_CURRENCY = gc.COUNTRY_CODE) management_currency_precision,
		  NULL AS pay2mag_exchange_type,
		  NULL AS pay2mag_exchange_type_name,
		  NULL AS pay2mag_exchange_rate,
		  (SELECT IFNULL( gae.FUNCTIONAL_CURRENCY_CODE, gsob.FUNCTIONAL_CURRENCY_CODE )
			FROM gld_accounting_entity gae,
				  gld_set_of_book gsob
			WHERE gae.ACC_ENTITY_ID = #{accEntityId}
            AND gsob.SET_OF_BOOKS_ID = gae.DEFAULT_SET_OF_BOOKS_ID) functional_currency_code,
			date_format( now( ), '%Y-%m-%d' ) requisition_date,
			NULL AS requisition_date_tz,
			NULL AS requisition_date_ltz,
			NULL AS period_name,
			'GENERATE' AS requisition_status,
			(SELECT scv.meaning
			FROM sys_code_value_b scv
			LEFT JOIN sys_code_b sc
			ON scv.code_id = sc.code_id
			WHERE scv.VALUE= 'GENERATE'
			AND sc.CODE = 'EXP_EXPENSE_REPORT_STATUS') requisition_status_name,
			NULL AS je_creation_status,
			NULL AS audit_flag,
			NULL AS gld_interface_flag,
			NULL AS attachment_num,
			NULL AS description,
			NULL AS released_status,
			NULL AS reversed_flag,
			NULL AS source_exp_req_header_id,
			NULL AS source_type,
			( SELECT ee.`NAME`
			FROM sys_user su,
			     exp_employee ee
			WHERE su.USER_ID = #{request.userId}
			  AND su.EMPLOYEE_ID = ee.EMPLOYEE_ID) created_by_name,
			'N' payment_flag,
							(
							SELECT
								emhd.default_dim_value_id
							FROM
								exp_mo_req_type_ref_hd_dim emhd,
								fnd_dimension fd
							WHERE
								emrt.mo_exp_req_type_id = emhd.mo_exp_req_type_id
								AND emhd.dimension_id = fd.dimension_id
								AND emhd.enabled_flag = 'Y'
								AND fd.dimension_sequence = '1'
								AND fd.enabled_flag = 'Y'
							) dimension1_id,
							(
							SELECT
								emhd.default_dim_value_id
							FROM
								exp_mo_req_type_ref_hd_dim emhd,
								fnd_dimension fd
							WHERE
								emrt.mo_exp_req_type_id = emhd.mo_exp_req_type_id
								AND emhd.dimension_id = fd.dimension_id
								AND emhd.enabled_flag = 'Y'
								AND fd.dimension_sequence = '2'
								AND fd.enabled_flag = 'Y'
							) dimension2_id,
							(
							SELECT
								emhd.default_dim_value_id
							FROM
								exp_mo_req_type_ref_hd_dim emhd,
								fnd_dimension fd
							WHERE
								emrt.mo_exp_req_type_id = emhd.mo_exp_req_type_id
								AND emhd.dimension_id = fd.dimension_id
								AND emhd.enabled_flag = 'Y'
								AND fd.dimension_sequence = '3'
								AND fd.enabled_flag = 'Y'
							) dimension3_id,
							(
							SELECT
								emhd.default_dim_value_id
							FROM
								exp_mo_req_type_ref_hd_dim emhd,
								fnd_dimension fd
							WHERE
								emrt.mo_exp_req_type_id = emhd.mo_exp_req_type_id
								AND emhd.dimension_id = fd.dimension_id
								AND emhd.enabled_flag = 'Y'
								AND fd.dimension_sequence = '4'
								AND fd.enabled_flag = 'Y'
							) dimension4_id,
							(
							SELECT
								emhd.default_dim_value_id
							FROM
								exp_mo_req_type_ref_hd_dim emhd,
								fnd_dimension fd
							WHERE
								emrt.mo_exp_req_type_id = emhd.mo_exp_req_type_id
								AND emhd.dimension_id = fd.dimension_id
								AND emhd.enabled_flag = 'Y'
								AND fd.dimension_sequence = '5'
								AND fd.enabled_flag = 'Y'
							) dimension5_id,
							(
							SELECT
								emhd.default_dim_value_id
							FROM
								exp_mo_req_type_ref_hd_dim emhd,
								fnd_dimension fd
							WHERE
								emrt.mo_exp_req_type_id = emhd.mo_exp_req_type_id
								AND emhd.dimension_id = fd.dimension_id
								AND emhd.enabled_flag = 'Y'
								AND fd.dimension_sequence = '6'
								AND fd.enabled_flag = 'Y'
							) dimension6_id,
							(
							SELECT
								emhd.default_dim_value_id
							FROM
								exp_mo_req_type_ref_hd_dim emhd,
								fnd_dimension fd
							WHERE
								emrt.mo_exp_req_type_id = emhd.mo_exp_req_type_id
								AND emhd.dimension_id = fd.dimension_id
								AND emhd.enabled_flag = 'Y'
								AND fd.dimension_sequence = '7'
								AND fd.enabled_flag = 'Y'
							) dimension7_id,
							(
							SELECT
								emhd.default_dim_value_id
							FROM
								exp_mo_req_type_ref_hd_dim emhd,
								fnd_dimension fd
							WHERE
								emrt.mo_exp_req_type_id = emhd.mo_exp_req_type_id
								AND emhd.dimension_id = fd.dimension_id
								AND emhd.enabled_flag = 'Y'
								AND fd.dimension_sequence = '8'
								AND fd.enabled_flag = 'Y'
							) dimension8_id,
							(
							SELECT
								emhd.default_dim_value_id
							FROM
								exp_mo_req_type_ref_hd_dim emhd,
								fnd_dimension fd
							WHERE
								emrt.mo_exp_req_type_id = emhd.mo_exp_req_type_id
								AND emhd.dimension_id = fd.dimension_id
								AND emhd.enabled_flag = 'Y'
								AND fd.dimension_sequence = '9'
								AND fd.enabled_flag = 'Y'
							) dimension9_id,
							(
							SELECT
								emhd.default_dim_value_id
							FROM
								exp_mo_req_type_ref_hd_dim emhd,
								fnd_dimension fd
							WHERE
								emrt.mo_exp_req_type_id = emhd.mo_exp_req_type_id
								AND emhd.dimension_id = fd.dimension_id
								AND emhd.enabled_flag = 'Y'
								AND fd.dimension_sequence = '10'
								AND fd.enabled_flag = 'Y'
							) dimension10_id,
							(
							SELECT
								emhd.default_dim_value_id
							FROM
								exp_mo_req_type_ref_hd_dim emhd,
								fnd_dimension fd
							WHERE
								emrt.mo_exp_req_type_id = emhd.mo_exp_req_type_id
								AND emhd.dimension_id = fd.dimension_id
								AND emhd.enabled_flag = 'Y'
								AND fd.dimension_sequence = '11'
								AND fd.enabled_flag = 'Y'
							) dimension11_id,
							(
							SELECT
								emhd.default_dim_value_id
							FROM
								exp_mo_req_type_ref_hd_dim emhd,
								fnd_dimension fd
							WHERE
								emrt.mo_exp_req_type_id = emhd.mo_exp_req_type_id
								AND emhd.dimension_id = fd.dimension_id
								AND emhd.enabled_flag = 'Y'
								AND fd.dimension_sequence = '12'
								AND fd.enabled_flag = 'Y'
							) dimension12_id,
							(
							SELECT
								emhd.default_dim_value_id
							FROM
								exp_mo_req_type_ref_hd_dim emhd,
								fnd_dimension fd
							WHERE
								emrt.mo_exp_req_type_id = emhd.mo_exp_req_type_id
								AND emhd.dimension_id = fd.dimension_id
								AND emhd.enabled_flag = 'Y'
								AND fd.dimension_sequence = '13'
								AND fd.enabled_flag = 'Y'
							) dimension13_id,
							(
							SELECT
								emhd.default_dim_value_id
							FROM
								exp_mo_req_type_ref_hd_dim emhd,
								fnd_dimension fd
							WHERE
								emrt.mo_exp_req_type_id = emhd.mo_exp_req_type_id
								AND emhd.dimension_id = fd.dimension_id
								AND emhd.enabled_flag = 'Y'
								AND fd.dimension_sequence = '14'
								AND fd.enabled_flag = 'Y'
							) dimension14_id,
							(
							SELECT
								emhd.default_dim_value_id
							FROM
								exp_mo_req_type_ref_hd_dim emhd,
								fnd_dimension fd
							WHERE
								emrt.mo_exp_req_type_id = emhd.mo_exp_req_type_id
								AND emhd.dimension_id = fd.dimension_id
								AND emhd.enabled_flag = 'Y'
								AND fd.dimension_sequence = '15'
								AND fd.enabled_flag = 'Y'
							) dimension15_id,
							(
							SELECT
								emhd.default_dim_value_id
							FROM
								exp_mo_req_type_ref_hd_dim emhd,
								fnd_dimension fd
							WHERE
								emrt.mo_exp_req_type_id = emhd.mo_exp_req_type_id
								AND emhd.dimension_id = fd.dimension_id
								AND emhd.enabled_flag = 'Y'
								AND fd.dimension_sequence = '16'
								AND fd.enabled_flag = 'Y'
							) dimension16_id,
							(
							SELECT
								emhd.default_dim_value_id
							FROM
								exp_mo_req_type_ref_hd_dim emhd,
								fnd_dimension fd
							WHERE
								emrt.mo_exp_req_type_id = emhd.mo_exp_req_type_id
								AND emhd.dimension_id = fd.dimension_id
								AND emhd.enabled_flag = 'Y'
								AND fd.dimension_sequence = '17'
								AND fd.enabled_flag = 'Y'
							) dimension17_id,
							(
							SELECT
								emhd.default_dim_value_id
							FROM
								exp_mo_req_type_ref_hd_dim emhd,
								fnd_dimension fd
							WHERE
								emrt.mo_exp_req_type_id = emhd.mo_exp_req_type_id
								AND emhd.dimension_id = fd.dimension_id
								AND emhd.enabled_flag = 'Y'
								AND fd.dimension_sequence = '18'
								AND fd.enabled_flag = 'Y'
							) dimension18_id,
							(
							SELECT
								emhd.default_dim_value_id
							FROM
								exp_mo_req_type_ref_hd_dim emhd,
								fnd_dimension fd
							WHERE
								emrt.mo_exp_req_type_id = emhd.mo_exp_req_type_id
								AND emhd.dimension_id = fd.dimension_id
								AND emhd.enabled_flag = 'Y'
								AND fd.dimension_sequence = '19'
								AND fd.enabled_flag = 'Y'
							) dimension19_id,
							(
							SELECT
								emhd.default_dim_value_id
							FROM
								exp_mo_req_type_ref_hd_dim emhd,
								fnd_dimension fd
							WHERE
								emrt.mo_exp_req_type_id = emhd.mo_exp_req_type_id
								AND emhd.dimension_id = fd.dimension_id
								AND emhd.enabled_flag = 'Y'
								AND fd.dimension_sequence = '20'
								AND fd.enabled_flag = 'Y'
							) dimension20_id,
							NULL AS departure_date,
							NULL AS arrival_date,
							emrt.auto_approve_flag
						FROM
							exp_mo_req_type emrt
							LEFT JOIN exp_mo_req_type_tl emrtt ON emrt.MO_EXP_REQ_TYPE_ID = emrtt.MO_EXP_REQ_TYPE_ID
							AND emrtt.lang=#{request.locale}

					WHERE emrt.mo_exp_req_type_id = #{moExpReqTypeId})v
    </select>

    <select id="expReportFromReqHeaderQuery" resultMap="BaseResultMap">
        SELECT
            h.exp_requisition_header_id,
            h.exp_requisition_number,
            h.description,
            h.mo_exp_req_type_id,
            (select emrtt.DESCRIPTION from exp_mo_req_type emrt left join exp_mo_req_type_tl emrtt on emrt.MO_EXP_REQ_TYPE_ID = emrtt.MO_EXP_REQ_TYPE_ID and emrtt.LANG = #{request.locale} where emrt.mo_exp_req_type_id = h.mo_exp_req_type_id) AS mo_exp_req_type_name,
            #{moExpReportTypeId} mo_exp_report_type_id,
            h.requisition_date,
            (SELECT
            SUM(l.payment_amount)
            FROM
            exp_requisition_line l
            WHERE
            l.exp_requisition_header_id = h.exp_requisition_header_id
            ) AS req_total_amount,
            h.employee_id,
            h.payment_currency_code,
            (select gct.CURRENCY_NAME from gld_currency gc left join gld_currency_tl gct on gc.CURRENCY_ID  = gct.CURRENCY_ID and gct.LANG = #{request.locale} where gc.CURRENCY_CODE = h.payment_currency_code) AS payment_currency_name
            FROM
            exp_requisition_header h
            WHERE
            h.requisition_status    = 'COMPLETELY_APPROVED' AND
            h.company_id            = #{request.companyId} AND
            h.payment_currency_code = #{paymentCurrencyCode} AND
            NOT EXISTS
            (SELECT
            1
            FROM
            exp_report_header erh
            <where>
                erh.exp_requisition_header_id = h.exp_requisition_header_id
                )AND
                h.mo_exp_req_type_id IN
                (SELECT
                rt.mo_exp_req_type_id
                FROM
                exp_mo_report_type rt
                WHERE
                rt.mo_exp_report_type_id = #{moExpReportTypeId}
                ) AND
                EXISTS (SELECT
                    1
                 FROM
                    exp_requisition_line l,
                    exp_requisition_dist d
                 WHERE
                    h.exp_requisition_header_id                               = l.exp_requisition_header_id AND
                    l.exp_requisition_line_id                                 = d.exp_requisition_line_id AND
                    d.close_flag                                              = 'N' AND
                greatest(d.payment_amount - (case when d.released_amount is null then 0 else d.released_amount end), 0) > 0 AND
                NOT EXISTS (SELECT
                                1
                            FROM
                                exp_mo_req_type em
                            WHERE
                                em.mo_exp_req_type_id = h.mo_exp_req_type_id AND
                (em.one_off_flag ='Y' AND EXISTS (SELECT
                                                    1
                                                  FROM
                                                    exp_requisition_release rr
                                                  WHERE
                                                    rr.exp_requisition_line_id=l.exp_requisition_line_id))))
                <if test="expRequisitionNumber!=null">
                   AND h.exp_requisition_number like concat('%',concat(#{expRequisitionNumber},'%'))
                </if>
                <if test="description!=null">
                   AND h.description like concat('%',concat(#{description},'%'))
                </if>
            </where>
            order by h.exp_requisition_number DESC

    </select>
</mapper>